<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUTCH | ULTIMATE MULTIPLAYER v13.0</title>
    <style>
        :root { 
            --accent: #1a73e8; --danger: #f44336; --bg: #ffffff;
            --ui-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', system-ui, sans-serif; background: #000; }

        /* ИНТЕРФЕЙС ГЛАВНОГО МЕНЮ */
        .full-screen {
            position: absolute; inset: 0; display: flex; 
            align-items: center; justify-content: center; 
            z-index: 2000; background: #fff; transition: opacity 0.5s;
        }

        .auth-card {
            width: 440px; padding: 60px; text-align: center;
            background: #fff; border-radius: 40px; border: 1px solid #eee;
        }

        h1 { font-size: 50px; font-weight: 900; color: var(--accent); letter-spacing: -2px; }
        p.tagline { color: #888; text-transform: uppercase; font-size: 11px; letter-spacing: 4px; margin-bottom: 40px; }

        input {
            width: 100%; padding: 20px; margin-bottom: 15px; border-radius: 20px;
            border: 2px solid #f0f0f0; background: #f8f8f8; font-size: 16px; outline: none;
        }
        input:focus { border-color: var(--accent); background: #fff; }

        .row { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 20px; border-radius: 20px; border: none;
            font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 15px;
        }
        button.primary { background: var(--accent); color: #fff; }
        button.secondary { background: #f0f0f0; color: #333; }
        button:hover { transform: translateY(-3px); filter: brightness(1.05); }

        /* HUD ИГРЫ */
        #game-ui {
            position: absolute; bottom: 40px; left: 40px; z-index: 500;
            pointer-events: none; display: none;
        }
        .hud-glass {
            background: rgba(255,255,255,0.9); padding: 30px; border-radius: 30px;
            box-shadow: var(--ui-shadow); backdrop-filter: blur(10px);
        }
        .hp-container { width: 240px; height: 12px; background: #eee; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        #hp-fill { width: 100%; height: 100%; background: var(--danger); transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        #ammo-count { font-size: 24px; font-weight: 900; }

        /* ЭФФЕКТЫ */
        #hit-marker {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; pointer-events: none; display: none;
        }
        #hit-marker::before, #hit-marker::after {
            content: ''; position: absolute; background: #f00;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 34px; height: 34px; pointer-events: none; z-index: 1000; display: none;
        }
        .ch-line { position: absolute; background: #000; }
        .ch-v { left: 16px; top: 0; width: 2px; height: 34px; }
        .ch-h { top: 16px; left: 0; width: 34px; height: 2px; }

        #msg-box {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            color: var(--danger); font-size: 50px; font-weight: 900; display: none;
        }

        #death-screen {
            position: absolute; inset: 0; background: #000; z-index: 5000;
            display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="msg-box">NO AMMO!</div>

    <div id="death-screen">
        <h1 style="color: white; font-size: 80px;">TERMINATED</h1>
        <p>RECONNECTING TO DATASTREAM...</p>
    </div>

    <div id="scr-auth" class="full-screen">
        <div class="auth-card">
            <h1>CLUTCH</h1>
            <p class="tagline">Cloud Combat v13.0</p>
            <input type="text" id="nick" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <div class="row">
                <button class="primary" id="btn-login">ENTER</button>
                <button class="secondary" id="btn-reg">CREATE</button>
            </div>
            <p id="auth-err" style="color: red; margin-top: 15px; font-weight: bold; font-size: 13px;"></p>
        </div>
    </div>

    <div id="scr-lobby" class="full-screen hidden">
        <div class="auth-card">
            <h1 id="player-name">USER</h1>
            <p class="tagline">Основано на анлайн и хытымылы</p>
            <button class="primary" id="btn-play" style="width: 100%; height: 80px; font-size: 20px; margin-bottom: 10px;">START MATCH</button>
            <div class="row">
                <button class="secondary" id="btn-stats">STATISTICS</button>
                <button class="secondary" id="btn-out">EXIT</button>
            </div>
        </div>
    </div>

    <div id="scr-stats" class="full-screen hidden" style="background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);">
        <div class="auth-card">
            <h1>RECORDS</h1>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
                <div style="background: #f9f9f9; padding: 25px; border-radius: 25px;">
                    <small>KILLS</small><br><strong id="k-val" style="font-size: 32px;">0</strong>
                </div>
                <div style="background: #f9f9f9; padding: 25px; border-radius: 25px;">
                    <small>DEATHS</small><br><strong id="d-val" style="font-size: 32px;">0</strong>
                </div>
            </div>
            <button class="primary" id="btn-close-stats" style="width: 100%;">BACK</button>
        </div>
    </div>

    <div id="game-ui">
        <div class="hud-glass">
            <div id="ammo-count">12 / 12</div>
            <div class="hp-container"><div id="hp-fill"></div></div>
            <div style="font-size: 10px; font-weight: 800; color: #888; text-transform: uppercase;">System Online // Region: EU</div>
        </div>
    </div>

    <div id="crosshair"><div class="ch-line ch-v"></div><div class="ch-line ch-h"></div></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, onDisconnect, update, remove, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRH07hc8tMsG1TvMyHOptrOTEJDp_4kE8",
            authDomain: "clutch-shuter.firebaseapp.com",
            projectId: "clutch-shuter",
            databaseURL: "https://clutch-shuter-default-rtdb.firebaseio.com",
            storageBucket: "clutch-shuter.firebasestorage.app",
            appId: "1:224141175517:web:671a68999f8cf6a2dc4934"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // State
        let hp = 100, ammo = 12, isDead = false, isPlaying = false;
        let kills = 0, deaths = 0;
        const enemies = {};

        // Audio
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function shotSound() {
            const o = audio.createOscillator();
            const g = audio.createGain();
            o.type = 'sawtooth';
            o.frequency.setValueAtTime(220, audio.currentTime);
            o.frequency.exponentialRampToValueAtTime(0.01, audio.currentTime + 0.1);
            g.gain.setValueAtTime(0.1, audio.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + 0.1);
            o.connect(g); g.connect(audio.destination);
            o.start(); o.stop(audio.currentTime + 0.1);
        }

        // UI
        const show = (id) => {
            document.querySelectorAll('.full-screen').forEach(el => el.classList.add('hidden'));
            if(id !== 'game') document.getElementById(id).classList.remove('hidden');
        };

        async function fetchRecords() {
            const s = await get(ref(db, `users/${auth.currentUser.uid}`));
            if(s.exists()) {
                kills = s.val().kills || 0; deaths = s.val().deaths || 0;
                document.getElementById('k-val').innerText = kills;
                document.getElementById('d-val').innerText = deaths;
            }
        }

        // Auth
        document.getElementById('btn-login').onclick = async () => {
            const n = document.getElementById('nick').value;
            const p = document.getElementById('pass').value;
            try { await signInWithEmailAndPassword(auth, `${n.toLowerCase()}@clutch.game`, p); } catch(e) { document.getElementById('auth-err').innerText = e.message; }
        };

        document.getElementById('btn-reg').onclick = async () => {
            const n = document.getElementById('nick').value;
            const p = document.getElementById('pass').value;
            try {
                const r = await createUserWithEmailAndPassword(auth, `${n.toLowerCase()}@clutch.game`, p);
                await updateProfile(r.user, { displayName: n });
                await set(ref(db, `users/${r.user.uid}`), { kills: 0, deaths: 0 });
            } catch(e) { document.getElementById('auth-err').innerText = e.message; }
        };

        onAuthStateChanged(auth, (u) => {
            if(u) { document.getElementById('player-name').innerText = u.displayName.toUpperCase(); show('scr-lobby'); fetchRecords(); }
            else show('scr-auth');
        });

        document.getElementById('btn-stats').onclick = () => { fetchRecords(); show('scr-stats'); };
        document.getElementById('btn-close-stats').onclick = () => show('scr-lobby');
        document.getElementById('btn-out').onclick = () => signOut(auth);

        // 3D Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xddeeff);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10); dirLight.castShadow = true;
        scene.add(dirLight);

        // Floor
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({color: 0xcccccc}));
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true;
        scene.add(floor);

        // Walls
        const wallM = new THREE.MeshStandardMaterial({color: 0x999999});
        const addWall = (w,h,d,x,z) => {
            const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), wallM);
            m.position.set(x, h/2, z); m.castShadow = true; m.receiveShadow = true;
            scene.add(m);
        };
        addWall(100, 5, 1, 0, 50); addWall(100, 5, 1, 0, -50);
        addWall(1, 5, 100, 50, 0); addWall(1, 5, 100, -50, 0);
        addWall(10, 4, 10, 15, 15); addWall(10, 4, 10, -15, -15);

        const gunPivot = new THREE.Group();
        const gun = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.45), new THREE.MeshStandardMaterial({color: 0x222}));
        gun.position.set(0.3, -0.25, -0.5); gunPivot.add(gun);
        scene.add(gunPivot);

        const controls = new PointerLockControls(camera, document.body);

        // Network Logic (THE FIX)
        function initNet() {
            const myId = auth.currentUser.uid;
            const myRef = ref(db, `players/${myId}`);
            
            // Удаляем старые данные
            remove(myRef);
            onDisconnect(myRef).remove();

            // Глобальный слушатель
            onValue(ref(db, 'players'), (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                for(let id in data) {
                    if(id === myId) {
                        // Если нам нанесли урон
                        if(data[id].hp < hp) {
                            hp = data[id].hp;
                            document.getElementById('hp-fill').style.width = hp + '%';
                            if(hp <= 0 && !isDead) performDeath();
                        }
                        continue;
                    }

                    const p = data[id];
                    if(!enemies[id]) {
                        // Создаем модель врага
                        const g = new THREE.Group();
                        const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1), new THREE.MeshStandardMaterial({color: 0x1a73e8}));
                        body.position.y = 1; g.add(body);

                        const visor = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.1), new THREE.MeshStandardMaterial({color: 0x000}));
                        visor.position.set(0, 1.5, -0.35); g.add(visor);

                        // Тэг игрока
                        const canvas = document.createElement('canvas');
                        canvas.width = 256; canvas.height = 128;
                        const tex = new THREE.CanvasTexture(canvas);
                        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: tex}));
                        sprite.position.y = 2.8; sprite.scale.set(2, 1, 1);
                        g.add(sprite);

                        scene.add(g);
                        enemies[id] = { obj: g, hitBox: body, ctx: canvas.getContext('2d'), tex: tex, lastHP: 100 };
                    }

                    const e = enemies[id];
                    e.obj.position.set(p.x, p.y, p.z);
                    e.obj.rotation.y = p.ry;
                    e.lastHP = p.hp;

                    // Отрисовка UI над головой
                    const ctx = e.ctx;
                    ctx.clearRect(0, 0, 256, 128);
                    ctx.fillStyle = 'black'; ctx.font = 'bold 30px Arial'; ctx.textAlign = 'center';
                    ctx.fillText(p.nick, 128, 40);
                    ctx.fillStyle = '#ccc'; ctx.fillRect(50, 60, 156, 15);
                    ctx.fillStyle = p.hp > 30 ? '#4CAF50' : '#F44336';
                    ctx.fillRect(50, 60, (p.hp/100)*156, 15);
                    e.tex.needsUpdate = true;
                }

                // Чистка ушедших
                for(let id in enemies) { if(!data[id]) { scene.remove(enemies[id].obj); delete enemies[id]; } }
            });
        }

        // Gameplay
        document.getElementById('btn-play').onclick = () => {
            if(audio.state === 'suspended') audio.resume();
            show('game');
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('crosshair').style.display = 'block';
            isPlaying = true;
            controls.lock();
            camera.position.set(Math.random()*20-10, 1.7, Math.random()*20-10);
            initNet();
        };

        const ray = new THREE.Raycaster();
        window.onmousedown = (e) => {
            if(!controls.isLocked || isDead || e.button !== 0) return;

            if(ammo <= 0) {
                const m = document.getElementById('msg-box'); m.style.display = 'block';
                setTimeout(() => m.style.display = 'none', 1000);
                return;
            }

            ammo--;
            document.getElementById('ammo-count').innerText = `${ammo} / 12`;
            shotSound();

            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            for(let id in enemies) {
                if(ray.intersectObject(enemies[id].hitBox).length > 0) {
                    const nextHP = Math.max(0, enemies[id].lastHP - 25);
                    update(ref(db, `players/${id}`), { hp: nextHP });
                    if(nextHP <= 0) {
                        kills++;
                        update(ref(db, `users/${auth.currentUser.uid}`), { kills: kills });
                    }
                }
            }

            if(ammo === 0) {
                setTimeout(() => { ammo = 12; document.getElementById('ammo-count').innerText = `12 / 12`; }, 2000);
            }
        };

        async function performDeath() {
            isDead = true; controls.unlock();
            deaths++;
            await update(ref(db, `users/${auth.currentUser.uid}`), { deaths: deaths });
            document.getElementById('death-screen').style.display = 'flex';
            setTimeout(() => location.reload(), 3000);
        }

        // Loop
        const k = {};
        window.onkeydown = (e) => k[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => k[e.key.toLowerCase()] = false;

        function animate() {
            requestAnimationFrame(animate);
            if(controls.isLocked && !isDead && isPlaying) {
                const moveSpeed = 0.16;
                if(k['w']) controls.moveForward(moveSpeed);
                if(k['s']) controls.moveForward(-moveSpeed);
                if(k['a']) controls.moveRight(-moveSpeed); // Тот самый фикс движения влево
                if(k['d']) controls.moveRight(moveSpeed);

                camera.position.x = Math.max(-48, Math.min(48, camera.position.x));
                camera.position.z = Math.max(-48, Math.min(48, camera.position.z));

                gunPivot.position.copy(camera.position);
                gunPivot.quaternion.copy(camera.quaternion);

                // SYNC TO FIREBASE
                update(ref(db, `players/${auth.currentUser.uid}`), {
                    x: camera.position.x, y: camera.position.y - 1.7, z: camera.position.z,
                    y: camera.rotation.y, nick: auth.currentUser.displayName, hp: hp
                });
            }
            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>