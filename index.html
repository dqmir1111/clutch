<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUTCH | ULTIMATE COMMAND v24.0</title>
    <style>
        :root {
            --p: #2563eb; --s: #64748b; --d: #ef4444; --success: #22c55e;
            --bg-dark: #020617; --glass: rgba(15, 23, 42, 0.95);
            --font: 'Inter', system-ui, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; font-family: var(--font); }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; }

        /* СКРИНЫ И ОВЕРЛЕИ */
        .overlay {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            z-index: 5000; background: radial-gradient(circle at center, #1e293b, #020617);
        }
        .window {
            width: 700px; padding: 50px; background: var(--glass);
            border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px); box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            text-align: center;
        }
        
        h1 { font-size: 80px; font-weight: 900; letter-spacing: -5px; line-height: 1; margin-bottom: 10px; }
        .badge { background: var(--p); padding: 5px 15px; border-radius: 10px; font-size: 11px; font-weight: 900; letter-spacing: 2px; }

        /* ИНПУТЫ И КНОПКИ */
        input[type="text"], input[type="password"] {
            width: 100%; padding: 20px; margin-bottom: 15px; border-radius: 15px;
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--p); box-shadow: 0 0 20px rgba(37, 99, 235, 0.3); }

        .btn {
            width: 100%; padding: 20px; border-radius: 15px; border: none; cursor: pointer;
            font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s; margin-bottom: 15px;
        }
        .btn-p { background: var(--p); color: #fff; }
        .btn-s { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-d { background: var(--d); color: #fff; }
        .btn:hover { filter: brightness(1.2); transform: translateY(-3px); }

        /* КАРТЫ */
        .maps { display: flex; gap: 20px; margin: 30px 0; }
        .map-card {
            flex: 1; padding: 20px; border-radius: 20px; background: rgba(255,255,255,0.05);
            border: 2px solid transparent; cursor: pointer; transition: 0.3s;
        }
        .map-card.active { border-color: var(--p); background: rgba(37,99,235,0.2); transform: scale(1.05); }
        .map-preview { height: 100px; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; }
        .mp-alpha { background: linear-gradient(45deg, #15803d, #22c55e); }
        .mp-void { background: linear-gradient(45deg, #020617, #1e293b); color: var(--p); }

        /* НАСТРОЙКИ (ПОЛЗУНКИ) */
        .settings-block { text-align: left; margin-bottom: 30px; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; }
        .range-wrap { margin-bottom: 20px; }
        .range-wrap label { display: flex; justify-content: space-between; font-size: 12px; font-weight: 800; color: var(--s); margin-bottom: 10px; }
        input[type="range"] { width: 100%; accent-color: var(--p); cursor: pointer; }

        /* HUD И ИГРА */
        #hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        .top-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; }
        .pill { background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); font-size: 12px; font-weight: 900; }
        
        .hp-ui { position: absolute; bottom: 40px; left: 40px; width: 300px; }
        .hp-bar { width: 100%; height: 15px; background: rgba(0,0,0,0.6); border-radius: 10px; margin-top: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        #hp-fill { width: 100%; height: 100%; background: var(--d); transition: 0.2s; }

        .ammo-ui { position: absolute; bottom: 40px; right: 40px; text-align: right; }
        #ammo-val { font-size: 80px; font-weight: 900; line-height: 0.8; }

        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px #fff; }

        /* АДМИНКА ТАБЫ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; background: rgba(255,255,255,0.05); border: none; color: #fff; cursor: pointer; border-radius: 10px; font-weight: 900; transition: 0.3s; }
        .tab-btn.active { background: var(--p); }
        .tab-content { display: none; height: 350px; overflow-y: auto; background: rgba(0,0,0,0.4); border-radius: 15px; padding: 10px; }
        .tab-content.active { display: block; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* МОДАЛКА БАНА */
        #ban-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="damage-fx" style="position:absolute; inset:0; background: radial-gradient(circle, transparent, rgba(239,68,68,0.5)); opacity:0; pointer-events:none; z-index:4000; transition:0.1s;"></div>

    <div id="ui-auth" class="overlay">
        <div class="window">
            <h1>CLUTCH</h1>
            <div class="badge" style="margin-bottom: 40px;">v24.0 COMMAND</div>
            <input type="text" id="inp-nick" placeholder="ПОЗЫВНОЙ">
            <input type="password" id="inp-pass" placeholder="ПАРОЛЬ">
            <button class="btn btn-p" id="btn-login">ВОЙТИ В СИСТЕМУ</button>
            <button class="btn btn-s" id="btn-reg">РЕГИСТРАЦИЯ</button>
            <p id="auth-err" style="color:var(--d); font-size:12px; font-weight:900; margin-top:15px;"></p>
        </div>
    </div>

    <div id="ui-lobby" class="overlay hidden">
        <div class="window" style="width: 800px;">
            <h2 id="lobby-name" style="font-size: 50px; text-transform: uppercase;">AGENT</h2>
            <div class="maps">
                <div class="map-card active" data-map="alpha">
                    <div class="map-preview mp-alpha">ALPHA</div>
                    <div style="font-size:12px; color:var(--s);">Полигон, здания, укрытия</div>
                </div>
                <div class="map-card" data-map="void">
                    <div class="map-preview mp-void">VOID</div>
                    <div style="font-size:12px; color:var(--s);">Ночная арена, блоки</div>
                </div>
            </div>
            <div class="settings-block">
                <div class="range-wrap">
                    <label><span>SENSITIVITY (МЫШЬ)</span> <span id="lbl-sens">1.2</span></label>
                    <input type="range" id="sl-sens" min="0.1" max="5.0" step="0.1" value="1.2">
                </div>
                <div class="range-wrap">
                    <label><span>VOLUME (ЗВУК)</span> <span id="lbl-vol">50%</span></label>
                    <input type="range" id="sl-vol" min="0" max="1" step="0.05" value="0.5">
                </div>
            </div>
            <div style="display:flex; gap:15px;">
                <button class="btn btn-p" id="btn-deploy" style="flex:2; font-size:24px; height:80px;">ВЫСАДКА</button>
                <button class="btn btn-s" id="btn-logout" style="flex:1; height:80px;">ВЫХОД</button>
            </div>
        </div>
    </div>

    <div id="ui-pause" class="overlay hidden" style="background: rgba(0,0,0,0.85); z-index: 4500;">
        <div class="window" style="width: 500px;">
            <h2 style="font-size: 40px; margin-bottom: 30px; letter-spacing: 5px;">ПАУЗА</h2>
            <div class="settings-block">
                <div class="range-wrap">
                    <label><span>SENSITIVITY</span> <span id="lbl-sens-p">1.2</span></label>
                    <input type="range" id="sl-sens-p" min="0.1" max="5.0" step="0.1" value="1.2">
                </div>
                <div class="range-wrap">
                    <label><span>VOLUME</span> <span id="lbl-vol-p">50%</span></label>
                    <input type="range" id="sl-vol-p" min="0" max="1" step="0.05" value="0.5">
                </div>
            </div>
            <button class="btn btn-p" id="btn-resume">ПРОДОЛЖИТЬ БОЙ</button>
            <button class="btn btn-d" id="btn-quit">ПОКИНУТЬ МАТЧ</button>
        </div>
    </div>

    <div id="ui-admin" class="overlay hidden" style="background: rgba(0,0,0,0.95); z-index: 5500;">
        <div class="window" style="width: 900px; border-color: var(--p);">
            <h2 style="color: var(--p); margin-bottom: 20px;">COMMAND TERMINAL [dqmjrka]</h2>
            
            <div class="tabs">
                <button class="tab-btn active" data-tab="tab-active">АКТИВНЫЕ ОБЪЕКТЫ</button>
                <button class="tab-btn" data-tab="tab-banned">ЧЕРНЫЙ СПИСОК</button>
            </div>

            <div id="tab-active" class="tab-content active"></div>
            <div id="tab-banned" class="tab-content"></div>

            <button class="btn btn-s" style="margin-top:20px;" onclick="document.getElementById('ui-admin').classList.add('hidden')">ЗАКРЫТЬ (P)</button>
        </div>
    </div>

    <div id="ban-modal">
        <div class="window" style="width: 400px; padding: 30px;">
            <h3 style="margin-bottom: 20px; color: var(--d);">РЕЖИМ БЛОКИРОВКИ</h3>
            <p id="ban-target-name" style="margin-bottom: 20px; font-weight: 900;"></p>
            <button class="btn btn-s" id="btn-ban-temp">НА 24 ЧАСА</button>
            <button class="btn btn-d" id="btn-ban-perm">НАВСЕГДА</button>
            <button class="btn btn-s" onclick="document.getElementById('ban-modal').style.display='none'" style="background: transparent; margin-top: 10px;">ОТМЕНА</button>
        </div>
    </div>

    <div id="hud">
        <div class="top-bar">
            <div class="pill" id="hud-ping">ПИНГ: --ms</div>
            <div class="pill" id="hud-online">ONLINE: 1</div>
        </div>
        <div class="hp-ui">
            <div style="font-weight:900; font-size:20px;" id="hp-txt">100 HP</div>
            <div class="hp-bar"><div id="hp-fill"></div></div>
        </div>
        <div class="ammo-ui">
            <div style="font-size:14px; font-weight:900; color:var(--s); letter-spacing:2px;">AMMO</div>
            <div id="ammo-val">12</div>
        </div>
        <div class="crosshair"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, onDisconnect, update, remove, set, get, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ЗАЩИТА КОДА
        window.addEventListener('keydown', e => {
            if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I"||e.key === "J"||e.key === "C")) || (e.ctrlKey && e.key === "u")) {
                e.preventDefault(); return false;
            }
        });

        // КОНФИГ FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDRH07hc8tMsG1TvMyHOptrOTEJDp_4kE8",
            authDomain: "clutch-shuter.firebaseapp.com",
            databaseURL: "https://clutch-shuter-default-rtdb.firebaseio.com",
            projectId: "clutch-shuter",
            storageBucket: "clutch-shuter.firebasestorage.app",
            messagingSenderId: "224141175517",
            appId: "1:224141175517:web:671a68999f8cf6a2dc4934"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        let myHP = 100, myAmmo = 12, maxAmmo = 12;
        let isDead = false, isPaused = false, isReloading = false;
        let activeMap = 'alpha';
        let currentBanTarget = null;
        let playersData = {}, enemies = {};
        
        // НАСТРОЙКИ
        const cfg = {
            sens: parseFloat(localStorage.getItem('cl_sens')) || 1.2,
            vol: parseFloat(localStorage.getItem('cl_vol')) || 0.5
        };

        // СИНХРОНИЗАЦИЯ ПОЛЗУНКОВ
        const updateCfgUI = () => {
            document.getElementById('sl-sens').value = cfg.sens;
            document.getElementById('sl-sens-p').value = cfg.sens;
            document.getElementById('lbl-sens').innerText = cfg.sens.toFixed(1);
            document.getElementById('lbl-sens-p').innerText = cfg.sens.toFixed(1);
            
            document.getElementById('sl-vol').value = cfg.vol;
            document.getElementById('sl-vol-p').value = cfg.vol;
            document.getElementById('lbl-vol').innerText = Math.round(cfg.vol * 100) + '%';
            document.getElementById('lbl-vol-p').innerText = Math.round(cfg.vol * 100) + '%';
        };
        updateCfgUI();

        const applyCfg = (e, type) => {
            cfg[type] = parseFloat(e.target.value);
            localStorage.setItem('cl_' + type, cfg[type]);
            updateCfgUI();
        };
        document.getElementById('sl-sens').oninput = e => applyCfg(e, 'sens');
        document.getElementById('sl-sens-p').oninput = e => applyCfg(e, 'sens');
        document.getElementById('sl-vol').oninput = e => applyCfg(e, 'vol');
        document.getElementById('sl-vol-p').oninput = e => applyCfg(e, 'vol');

        // ВЫБОР КАРТЫ
        document.querySelectorAll('.map-card').forEach(c => {
            c.onclick = () => {
                document.querySelectorAll('.map-card').forEach(x => x.classList.remove('active'));
                c.classList.add('active');
                activeMap = c.dataset.map;
            };
        });

        // АВТОРИЗАЦИЯ И ПРОВЕРКА БАНОВ
        const showUI = id => {
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
            if(id !== 'game') document.getElementById(id).classList.remove('hidden');
        };

        const checkBan = async (uid) => {
            const snap = await get(ref(db, `banned/${uid}`));
            if(snap.exists()) {
                const data = snap.val();
                if(data.expires === -1 || data.expires > Date.now()) {
                    return true;
                } else {
                    await remove(ref(db, `banned/${uid}`)); // Истек
                    return false;
                }
            }
            return false;
        };

        document.getElementById('btn-login').onclick = async () => {
            const nick = document.getElementById('inp-nick').value;
            try {
                const res = await signInWithEmailAndPassword(auth, `${nick.toLowerCase()}@clutch.io`, document.getElementById('inp-pass').value);
                if(await checkBan(res.user.uid)) {
                    signOut(auth);
                    document.getElementById('auth-err').innerText = "АККАУНТ ЗАБЛОКИРОВАН АДМИНИСТРАТОРОМ";
                }
            } catch(e) { document.getElementById('auth-err').innerText = "ОШИБКА АВТОРИЗАЦИИ"; }
        };

        document.getElementById('btn-reg').onclick = async () => {
            const nick = document.getElementById('inp-nick').value;
            try {
                const res = await createUserWithEmailAndPassword(auth, `${nick.toLowerCase()}@clutch.io`, document.getElementById('inp-pass').value);
                await updateProfile(res.user, { displayName: nick });
            } catch(e) { document.getElementById('auth-err').innerText = "ОШИБКА РЕГИСТРАЦИИ"; }
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async u => {
            if(u) {
                if(await checkBan(u.uid)) { signOut(auth); return; }
                document.getElementById('lobby-name').innerText = u.displayName;
                showUI('ui-lobby');
                setupAdminPanel();
            } else {
                showUI('ui-auth');
            }
        });

        // ----------------------------------------------------
        // THREE.JS CORE & ИСПРАВЛЕНИЕ ОРУЖИЯ
        // ----------------------------------------------------
        const scene = new THREE.Scene();
        // ВАЖНО: Камеру добавляем в сцену, чтобы жестко привязать к ней оружие
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        scene.add(camera); 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);

        // ОРУЖИЕ (ПРИБИВАЕМ К КАМЕРЕ)
        const weaponGroup = new THREE.Group();
        const gunMesh = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.6), new THREE.MeshStandardMaterial({color: 0x222222}));
        gunMesh.position.set(0.3, -0.3, -0.5); // Позиция относительно камеры
        weaponGroup.add(gunMesh);
        
        // Руки
        const armGeo = new THREE.BoxGeometry(0.08, 0.08, 0.4);
        const armMat = new THREE.MeshStandardMaterial({color: 0x2563eb});
        const armR = new THREE.Mesh(armGeo, armMat);
        armR.position.set(0.3, -0.4, -0.2);
        weaponGroup.add(armR);
        const armL = new THREE.Mesh(armGeo, armMat);
        armL.position.set(-0.2, -0.4, -0.3);
        armL.rotation.y = 0.5;
        weaponGroup.add(armL);

        camera.add(weaponGroup); // ФИКС БАГА: Оружие теперь часть камеры, не будет трястись!

        // СВЕТ
        const ambLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // ГРУППЫ КАРТЫ
        const mapGroup = new THREE.Group();
        scene.add(mapGroup);
        const collisionObjects = [];

        // ГЕНЕРАЦИЯ КАРТ
        function buildMap(type) {
            // Очистка старой карты
            while(mapGroup.children.length > 0){ 
                const obj = mapGroup.children[0];
                mapGroup.remove(obj); 
            }
            collisionObjects.length = 0;

            if(type === 'alpha') {
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog = new THREE.FogExp2(0x87CEEB, 0.01);
                
                // Зеленый пол
                const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x22c55e, roughness: 1}));
                floor.rotation.x = -Math.PI/2; floor.receiveShadow = true;
                mapGroup.add(floor);

                // Генерация стен (Кирпичный цвет)
                const wallMat = new THREE.MeshStandardMaterial({color: 0xb91c1c});
                for(let i=0; i<30; i++) {
                    const w = new THREE.Mesh(new THREE.BoxGeometry(20, 10, 2), wallMat);
                    w.position.set((Math.random()-0.5)*200, 5, (Math.random()-0.5)*200);
                    w.rotation.y = Math.random() * Math.PI;
                    w.castShadow = true; w.receiveShadow = true;
                    mapGroup.add(w); collisionObjects.push(w);
                }

                // Генерация домиков
                const houseMat = new THREE.MeshStandardMaterial({color: 0xfde047});
                const roofMat = new THREE.MeshStandardMaterial({color: 0x991b1b});
                for(let i=0; i<15; i++) {
                    const x = (Math.random()-0.5)*300;
                    const z = (Math.random()-0.5)*300;
                    
                    // База дома
                    const base = new THREE.Mesh(new THREE.BoxGeometry(15, 12, 15), houseMat);
                    base.position.set(x, 6, z);
                    base.castShadow = true; base.receiveShadow = true;
                    mapGroup.add(base); collisionObjects.push(base);

                    // Крыша
                    const roof = new THREE.Mesh(new THREE.ConeGeometry(12, 8, 4), roofMat);
                    roof.position.set(x, 16, z);
                    roof.rotation.y = Math.PI/4;
                    roof.castShadow = true;
                    mapGroup.add(roof);
                }
            } else {
                // VOID КАРТА
                scene.background = new THREE.Color(0x020617);
                scene.fog = new THREE.FogExp2(0x020617, 0.02);
                
                const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x0f172a}));
                floor.rotation.x = -Math.PI/2;
                mapGroup.add(floor);

                const blockMat = new THREE.MeshStandardMaterial({color: 0x1e293b});
                for(let i=0; i<60; i++) {
                    const b = new THREE.Mesh(new THREE.BoxGeometry(10, Math.random()*20+5, 10), blockMat);
                    b.position.set((Math.random()-0.5)*200, b.geometry.parameters.height/2, (Math.random()-0.5)*200);
                    mapGroup.add(b); collisionObjects.push(b);
                }
            }
        }

        // ----------------------------------------------------
        // СЕТЬ И АДМИНКА
        // ----------------------------------------------------
        function setupAdminPanel() {
            if(auth.currentUser.displayName !== 'dqmjrka') return;

            // Табы
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                };
            });

            // Слушаем игроков
            onValue(ref(db, 'players'), s => {
                const data = s.val() || {};
                const list = document.getElementById('tab-active');
                list.innerHTML = '';
                for(let id in data) {
                    const div = document.createElement('div'); div.className = 'list-item';
                    div.innerHTML = `
                        <span><b>${data[id].nick}</b> (Map: ${data[id].map})</span>
                        <div>
                            <button class="btn btn-s" style="width:auto; padding:8px 15px; margin:0;" onclick="window.kick('${id}')">KICK</button>
                            <button class="btn btn-d" style="width:auto; padding:8px 15px; margin:0; margin-left:10px;" onclick="window.openBanModal('${id}', '${data[id].nick}')">BAN</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });

            // Слушаем забаненных
            onValue(ref(db, 'banned'), s => {
                const data = s.val() || {};
                const list = document.getElementById('tab-banned');
                list.innerHTML = '';
                for(let id in data) {
                    const div = document.createElement('div'); div.className = 'list-item';
                    const exp = data[id].expires === -1 ? 'НАВСЕГДА' : new Date(data[id].expires).toLocaleString();
                    div.innerHTML = `
                        <span><b>${data[id].nick}</b> <span style="color:var(--d); font-size:11px;">[До: ${exp}]</span></span>
                        <button class="btn btn-success" style="background:var(--success); color:#fff; width:auto; padding:8px 15px; margin:0; border:none; border-radius:10px; cursor:pointer;" onclick="window.unban('${id}')">РАЗБАН</button>
                    `;
                    list.appendChild(div);
                }
            });
        }

        window.kick = id => remove(ref(db, `players/${id}`));
        window.unban = id => remove(ref(db, `banned/${id}`));
        window.openBanModal = (id, nick) => {
            currentBanTarget = { id, nick };
            document.getElementById('ban-target-name').innerText = `ИГРОК: ${nick}`;
            document.getElementById('ban-modal').style.display = 'flex';
        };

        const executeBan = (type) => {
            if(!currentBanTarget) return;
            const exp = type === 'temp' ? Date.now() + (24 * 60 * 60 * 1000) : -1;
            set(ref(db, `banned/${currentBanTarget.id}`), { nick: currentBanTarget.nick, expires: exp });
            remove(ref(db, `players/${currentBanTarget.id}`)); // Кик из онлайна
            document.getElementById('ban-modal').style.display = 'none';
        };
        document.getElementById('btn-ban-temp').onclick = () => executeBan('temp');
        document.getElementById('btn-ban-perm').onclick = () => executeBan('perm');

        // ИГРОВОЙ СЕТЕВОЙ ЦИКЛ
        function startNetwork() {
            const myRef = ref(db, `players/${auth.currentUser.uid}`);
            onDisconnect(myRef).remove();

            onValue(ref(db, 'players'), snap => {
                playersData = snap.val() || {};
                document.getElementById('hud-online').innerText = `ONLINE: ${Object.keys(playersData).length}`;

                // Проверка себя
                if(!playersData[auth.currentUser.uid] && !isDead) { location.reload(); }

                if(playersData[auth.currentUser.uid]) {
                    if(playersData[auth.currentUser.uid].hp < myHP) {
                        myHP = playersData[auth.currentUser.uid].hp;
                        updateHUD();
                        document.getElementById('damage-fx').style.opacity = 1;
                        setTimeout(() => document.getElementById('damage-fx').style.opacity = 0, 150);
                        playSound(150, 'sine', 0.2);
                        if(myHP <= 0 && !isDead) { isDead = true; location.reload(); }
                    }
                }

                // Враги
                for(let id in playersData) {
                    if(id === auth.currentUser.uid || playersData[id].map !== activeMap) continue;
                    
                    if(!enemies[id]) {
                        const grp = new THREE.Group();
                        const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.2), new THREE.MeshStandardMaterial({color: 0xef4444}));
                        body.position.y = 1.1; grp.add(body);
                        
                        const cvs = document.createElement('canvas'); cvs.width = 256; cvs.height = 64;
                        const tex = new THREE.CanvasTexture(cvs);
                        const spr = new THREE.Sprite(new THREE.SpriteMaterial({map: tex}));
                        spr.position.y = 2.5; spr.scale.set(2, 0.5, 1);
                        grp.add(spr);
                        
                        scene.add(grp);
                        enemies[id] = { group: grp, body: body, ctx: cvs.getContext('2d'), tex: tex };
                    }

                    const e = enemies[id];
                    const d = playersData[id];
                    e.group.position.lerp(new THREE.Vector3(d.x, d.y, d.z), 0.3);
                    e.group.rotation.y = d.ry;
                    
                    // Обновление имени и HP
                    const c = e.ctx; c.clearRect(0,0,256,64);
                    c.fillStyle = '#fff'; c.font = 'bold 24px Arial'; c.textAlign = 'center';
                    c.fillText(d.nick, 128, 25);
                    c.fillStyle = '#000'; c.fillRect(64, 35, 128, 10);
                    c.fillStyle = d.hp > 30 ? '#22c55e' : '#ef4444'; c.fillRect(64, 35, (d.hp/100)*128, 10);
                    e.tex.needsUpdate = true;
                }

                // Удаление отключившихся
                for(let id in enemies) {
                    if(!playersData[id] || playersData[id].map !== activeMap) {
                        scene.remove(enemies[id].group);
                        delete enemies[id];
                    }
                }
            });
        }

        // ----------------------------------------------------
        // МЕХАНИКИ
        // ----------------------------------------------------
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(f, t, d) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(cfg.vol * 0.2, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function updateHUD() {
            document.getElementById('hp-txt').innerText = `${Math.max(0, myHP)} HP`;
            document.getElementById('hp-fill').style.width = Math.max(0, myHP) + '%';
            document.getElementById('ammo-val').innerText = myAmmo;
        }

        function reload() {
            if(isReloading || myAmmo === maxAmmo) return;
            isReloading = true; playSound(300, 'square', 0.4);
            weaponGroup.position.y -= 0.5;
            weaponGroup.rotation.x = -0.5;
            setTimeout(() => {
                myAmmo = maxAmmo; isReloading = false;
                weaponGroup.position.y += 0.5;
                weaponGroup.rotation.x = 0;
                updateHUD();
            }, 1500);
        }

        document.getElementById('btn-deploy').onclick = () => {
            controls.pointerSpeed = cfg.sens;
            buildMap(activeMap);
            showUI('game'); document.getElementById('hud').style.display = 'block';
            controls.lock();
            camera.position.set(0, 1.7, 0);
            update(ref(db, `players/${auth.currentUser.uid}`), {
                nick: auth.currentUser.displayName, map: activeMap, hp: 100, x:0, y:0, z:0, ry:0
            });
            startNetwork();
        };

        const ray = new THREE.Raycaster();
        window.addEventListener('mousedown', e => {
            if(!controls.isLocked || isDead || isReloading) return;
            if(e.button === 0) {
                if(myAmmo <= 0) { reload(); return; }
                myAmmo--; updateHUD();
                playSound(400, 'sawtooth', 0.1);
                
                // Отдача
                weaponGroup.position.z += 0.15;
                setTimeout(() => weaponGroup.position.z -= 0.15, 50);

                ray.setFromCamera(new THREE.Vector2(0,0), camera);
                for(let id in enemies) {
                    if(ray.intersectObject(enemies[id].body).length > 0) {
                        playSound(1000, 'sine', 0.1);
                        runTransaction(ref(db, `players/${id}/hp`), h => (h || 100) - 25);
                    }
                }
            }
        });

        // ESC МЕНЮ И КЛАВИШИ
        controls.addEventListener('lock', () => { isPaused = false; document.getElementById('ui-pause').classList.add('hidden'); });
        controls.addEventListener('unlock', () => { 
            if(!isDead && document.getElementById('hud').style.display === 'block') {
                isPaused = true; 
                document.getElementById('ui-pause').classList.remove('hidden'); 
            }
        });

        document.getElementById('btn-resume').onclick = () => {
            controls.pointerSpeed = cfg.sens; // Применяем настройки из паузы
            controls.lock();
        };
        document.getElementById('btn-quit').onclick = () => location.reload();

        const keys = {};
        window.onkeydown = e => {
            keys[e.code] = true;
            if(e.code === 'KeyR') reload();
            if(e.code === 'KeyP' && auth.currentUser.displayName === 'dqmjrka') {
                if(document.getElementById('ui-admin').classList.contains('hidden')){
                    document.getElementById('ui-admin').classList.remove('hidden');
                    controls.unlock();
                } else {
                    document.getElementById('ui-admin').classList.add('hidden');
                    controls.lock();
                }
            }
        };
        window.onkeyup = e => keys[e.code] = false;

        // ИГРОВОЙ ЦИКЛ
        const clock = new THREE.Clock();
        let lastSync = 0, lastPos = new THREE.Vector3();

        function loop() {
            requestAnimationFrame(loop);
            if(!controls.isLocked || isDead) { renderer.render(scene, camera); return; }

            const dt = Math.min(clock.getDelta(), 0.1);
            const speed = 15 * dt;

            // Движение с простой коллизией (Raycaster вниз и вперед)
            let moveX = 0, moveZ = 0;
            if(keys['KeyW']) moveZ -= speed;
            if(keys['KeyS']) moveZ += speed;
            if(keys['KeyA']) moveX -= speed;
            if(keys['KeyD']) moveX += speed;

            if(moveX !== 0 || moveZ !== 0) {
                controls.moveRight(moveX);
                controls.moveForward(-moveZ);
            }

            // Плавное возвращение оружия (Дыхание/Боббинг)
            if(moveX !== 0 || moveZ !== 0) {
                weaponGroup.position.y = -0.3 + Math.sin(Date.now() * 0.01) * 0.02;
            } else {
                weaponGroup.position.y = THREE.MathUtils.lerp(weaponGroup.position.y, -0.3, 0.1);
            }

            // Синхронизация (отправляем только если сдвинулись или повернулись)
            if(Date.now() - lastSync > 50) {
                if(lastPos.distanceTo(camera.position) > 0.1 || Math.abs(camera.rotation.y) > 0.1) {
                    update(ref(db, `players/${auth.currentUser.uid}`), {
                        x: camera.position.x, y: camera.position.y - 1.7, z: camera.position.z, ry: camera.rotation.y
                    });
                    lastPos.copy(camera.position);
                    lastSync = Date.now();
                }
            }

            renderer.render(scene, camera);
        }
        loop();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
