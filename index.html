<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUTCH | OMEGA PROTOCOL v1</title>
    <style>
        :root { 
            --p: #2563eb; --s: #64748b; --d: #ef4444; --bg: #020617; 
            --glass: rgba(15, 23, 42, 0.9); --accent: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; }

        /* ЭКРАНЫ И МЕНЮ */
        .overlay {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            z-index: 2000; background: radial-gradient(circle at center, #1e293b, #020617);
        }

        .card {
            width: 550px; padding: 50px; background: var(--glass);
            border-radius: 40px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(25px); text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }

        h1 { font-size: 60px; font-weight: 900; letter-spacing: -4px; margin-bottom: 5px; text-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .tagline { color: var(--s); font-size: 10px; letter-spacing: 5px; text-transform: uppercase; margin-bottom: 35px; }

        /* INPUTS */
        input, select {
            width: 100%; padding: 20px 25px; margin-bottom: 15px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.4);
            color: #fff; font-size: 16px; outline: none; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input:focus { border-color: var(--p); background: rgba(0,0,0,0.6); box-shadow: 0 0 20px rgba(37, 99, 235, 0.2); }

        /* BUTTONS */
        .row { display: flex; gap: 12px; margin-top: 10px; }
        button {
            flex: 1; padding: 20px; border-radius: 20px; border: none;
            font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 15px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-p { background: var(--p); color: #fff; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-s { background: rgba(255,255,255,0.05); color: #fff; }
        button:hover { transform: translateY(-3px); filter: brightness(1.2); }
        button:active { transform: translateY(-1px); }

        /* ВЫБОР КАРТЫ */
        .map-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .map-opt { 
            padding: 20px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.05); 
            background: rgba(0,0,0,0.2); cursor: pointer; transition: 0.3s;
        }
        .map-opt.active { border-color: var(--p); background: rgba(37, 99, 235, 0.1); }
        .map-opt b { display: block; margin-top: 5px; font-size: 14px; }

        /* ИГРОВОЙ HUD */
        #hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        
        .top-bar { position: absolute; top: 30px; width: 100%; display: flex; justify-content: center; gap: 30px; }
        .stat-badge { background: rgba(0,0,0,0.7); padding: 10px 25px; border-radius: 30px; font-size: 12px; font-weight: 900; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }

        .center-hud { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 400px; text-align: center; }
        .hp-text { font-size: 18px; font-weight: 900; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .hp-track { width: 100%; height: 14px; background: rgba(255,255,255,0.1); border-radius: 7px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        #hp-fill { width: 100%; height: 100%; background: var(--d); transition: 0.2s; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }

        .ammo-box { position: absolute; bottom: 50px; right: 60px; text-align: right; }
        #ammo-val { font-size: 72px; font-weight: 900; line-height: 0.8; }
        #reload-tip { color: #fbbf24; font-size: 14px; font-weight: 900; letter-spacing: 2px; display: none; animation: flash 0.6s infinite; }

        @keyframes flash { 50% { opacity: 0; } }

        /* ЭФФЕКТЫ */
        #dmg-vignette { position: absolute; inset: 0; background: radial-gradient(circle, transparent 30%, rgba(239,68,68,0.4) 100%); pointer-events: none; z-index: 1500; opacity: 0; transition: 0.1s; }
        #cross { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; pointer-events: none; }
        .cross-line { position: absolute; background: #fff; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .cv { left: 9px; width: 2px; height: 20px; }
        .ch { top: 9px; width: 20px; height: 2px; }

        /* DEATH SCREEN */
        #death-overlay { 
            position: absolute; inset: 0; background: #450a0a; z-index: 5000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }

        #esc-menu { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="dmg-vignette"></div>

    <div id="scr-death" class="hidden" style="position:fixed; inset:0; z-index:9999; background:#7f1d1d; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="font-size:120px; color:#fff;">TERMINATED</h1>
        <p style="letter-spacing:10px; margin-bottom:40px;">CRITICAL SYSTEM FAILURE</p>
        <button class="btn-p" style="width:250px;" onclick="location.reload()">REBOOT</button>
    </div>

    <div id="scr-auth" class="overlay">
        <div class="card">
            <h1>CLUTCH</h1>
            <div class="tagline">Next-Gen Network v19.0</div>
            <input type="text" id="auth-user" placeholder="Callsign or Email">
            <input type="password" id="auth-pass" placeholder="Security Key">
            <div class="row">
                <button class="btn-p" id="do-login">LOGIN</button>
                <button class="btn-s" id="do-reg">REGISTER</button>
            </div>
            <p id="auth-err" style="color:var(--d); font-size:12px; margin-top:20px; font-weight:800;"></p>
        </div>
    </div>

    <div id="scr-lobby" class="overlay hidden">
        <div class="card">
            <h1 id="lobby-nick">OPERATOR</h1>
            <div class="tagline" id="lobby-stats">PING: -- | ONLINE: --</div>
            
            <div class="map-selector">
                <div class="map-opt active" data-map="desert">
                    <div style="height:80px; background:#431407; border-radius:12px; margin-bottom:10px;"></div>
                    <b>DESERT POST</b>
                </div>
                <div class="map-opt" data-map="night">
                    <div style="height:80px; background:#020617; border-radius:12px; margin-bottom:10px;"></div>
                    <b>NIGHT OPS</b>
                </div>
            </div>

            <button class="btn-p" id="do-deploy" style="height:100px; font-size:28px; margin-bottom:15px;">DEPLOY TO SECTOR</button>
            <div class="row">
                <button class="btn-s" id="open-settings">CONFIG</button>
                <button class="btn-s" id="open-profile">PROFILE</button>
            </div>
            <button class="btn-s" id="do-logout" style="width:100%; margin-top:15px; background:transparent;">DISCONNECT</button>
        </div>
    </div>

    <div id="scr-profile" class="overlay hidden">
        <div class="card">
            <h1>RECORDS</h1>
            <div class="row" style="margin: 30px 0;">
                <div class="map-opt" style="flex:1;"><b>KILLS</b><h2 id="p-kills" style="font-size:48px;">0</h2></div>
                <div class="map-opt" style="flex:1;"><b>DEATHS</b><h2 id="p-deaths" style="font-size:48px;">0</h2></div>
            </div>
            <button class="btn-p" id="close-profile">BACK TO HUB</button>
        </div>
    </div>

    <div id="scr-set" class="overlay hidden">
        <div class="card">
            <h1>CONFIG</h1>
            <div style="text-align:left; margin: 30px 0;">
                <label style="font-size:11px; color:var(--s);">MOUSE SENSITIVITY</label>
                <input type="range" id="set-sens" min="0.1" max="5.0" step="0.1" style="width:100%;">
                <label style="font-size:11px; color:var(--s);">AUDIO VOLUME</label>
                <input type="range" id="set-vol" min="0" max="1" step="0.1" style="width:100%;">
            </div>
            <button class="btn-p" id="save-set">SAVE SETTINGS</button>
        </div>
    </div>

    <div id="esc-menu">
        <div class="card" style="width:350px;">
            <h2>PAUSED</h2>
            <div style="margin-top:25px;">
                <button class="btn-p" id="esc-resume" style="width:100%; margin-bottom:10px;">RESUME</button>
                <button class="btn-s" id="esc-lobby" style="width:100%;">EXIT TO HUB</button>
            </div>
        </div>
    </div>

    <div id="hud">
        <div class="top-bar">
            <div class="stat-badge" id="hud-ping">PING: 0ms</div>
            <div class="stat-badge" id="hud-online">ONLINE: 1</div>
            <div class="stat-badge" id="hud-sector">SECTOR: DESERT</div>
        </div>

        <div class="center-hud">
            <div class="hp-text" id="hud-hp-txt">100 HP</div>
            <div class="hp-track"><div id="hp-fill"></div></div>
        </div>

        <div class="ammo-box">
            <div id="reload-tip">RELOADING...</div>
            <div id="ammo-val">12</div>
            <div style="font-size:14px; font-weight:900; color:var(--p);">MAGAZINE</div>
        </div>

        <div id="cross">
            <div class="cross-line cv"></div>
            <div class="cross-line ch"></div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, onDisconnect, update, remove, get, set, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE SETUP
        const firebaseConfig = {
            apiKey: "AIzaSyDRH07hc8tMsG1TvMyHOptrOTEJDp_4kE8",
            authDomain: "clutch-shuter.firebaseapp.com",
            projectId: "clutch-shuter",
            databaseURL: "https://clutch-shuter-default-rtdb.firebaseio.com",
            storageBucket: "clutch-shuter.firebasestorage.app",
            appId: "1:224141175517:web:671a68999f8cf6a2dc4934"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // STATE ENGINE
        let myHP = 100, myAmmo = 12, maxAmmo = 12, isDead = false, isReloading = false, activeSector = 'desert';
        let ping = 0, totalKills = 0, totalDeaths = 0;
        const enemies = {};
        const config = { 
            sens: parseFloat(localStorage.getItem('cl_sens')) || 1.2, 
            vol: parseFloat(localStorage.getItem('cl_vol')) || 0.5 
        };

        // UI HELPERS
        const view = (id) => {
            document.querySelectorAll('.overlay').forEach(s => s.classList.add('hidden'));
            if(id !== 'game') document.getElementById(id).classList.remove('hidden');
        };

        // MAP LOGIC
        document.querySelectorAll('.map-opt').forEach(opt => {
            opt.onclick = () => {
                document.querySelectorAll('.map-opt').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                activeSector = opt.dataset.map;
                document.getElementById('hud-sector').innerText = `SECTOR: ${activeSector.toUpperCase()}`;
            };
        });

        // AUTH SYSTEM (GITHUB STYLE)
        document.getElementById('do-login').onclick = async () => {
            const id = document.getElementById('auth-user').value;
            const email = id.includes('@') ? id : `${id.toLowerCase()}@clutch.net`;
            try { await signInWithEmailAndPassword(auth, email, document.getElementById('auth-pass').value); }
            catch(e) { document.getElementById('auth-err').innerText = "ACCESS DENIED: INVALID KEY"; }
        };

        document.getElementById('do-reg').onclick = async () => {
            const id = document.getElementById('auth-user').value;
            if(id.includes('@')) { document.getElementById('auth-err').innerText = "USE NICKNAME FOR SIGNUP"; return; }
            try {
                const r = await createUserWithEmailAndPassword(auth, `${id.toLowerCase()}@clutch.net`, document.getElementById('auth-pass').value);
                await updateProfile(r.user, { displayName: id });
                await set(ref(db, `users/${r.user.uid}`), { kills:0, deaths:0 });
            } catch(e) { document.getElementById('auth-err').innerText = e.message; }
        };

        onAuthStateChanged(auth, u => {
            if(u) { 
                document.getElementById('lobby-nick').innerText = u.displayName.toUpperCase(); 
                view('scr-lobby'); 
                syncUserData();
                initNetworkStats();
            } else view('scr-auth');
        });

        async function syncUserData() {
            const s = await get(ref(db, `users/${auth.currentUser.uid}`));
            if(s.exists()) {
                totalKills = s.val().kills || 0;
                totalDeaths = s.val().deaths || 0;
                document.getElementById('p-kills').innerText = totalKills;
                document.getElementById('p-deaths').innerText = totalDeaths;
            }
        }

        document.getElementById('open-profile').onclick = () => { syncUserData(); view('scr-profile'); };
        document.getElementById('close-profile').onclick = () => view('scr-lobby');
        document.getElementById('open-settings').onclick = () => {
            document.getElementById('set-sens').value = config.sens;
            document.getElementById('set-vol').value = config.vol;
            view('scr-set');
        };
        document.getElementById('save-set').onclick = () => {
            config.sens = parseFloat(document.getElementById('set-sens').value);
            config.vol = parseFloat(document.getElementById('set-vol').value);
            localStorage.setItem('cl_sens', config.sens);
            localStorage.setItem('cl_vol', config.vol);
            view('scr-lobby');
        };
        document.getElementById('do-logout').onclick = () => signOut(auth);

        // 3D WORLD ENGINE
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const amb = new THREE.AmbientLight(0xffffff, 0.5); scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffffff, 1); sun.position.set(50, 100, 50); sun.castShadow = true;
        scene.add(sun);

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshStandardMaterial({color: 0x1e293b}));
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true;
        scene.add(floor);

        // GUN BUILDER
        const gunG = new THREE.Group();
        const gunM = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.18, 0.7), new THREE.MeshStandardMaterial({color: 0x000}));
        gunM.position.set(0.35, -0.35, -0.6); gunG.add(gunM);
        scene.add(gunG);

        const controls = new PointerLockControls(camera, document.body);

        function buildEnvironment(map) {
            scene.children.filter(c => c.isMapObj).forEach(c => scene.remove(c));
            scene.background = new THREE.Color(map === 'desert' ? 0x94a3b8 : 0x020617);
            
            const wallM = new THREE.MeshStandardMaterial({color: map === 'desert' ? 0x475569 : 0x1e293b});
            const addObj = (w,h,d,x,z) => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), wallM);
                m.position.set(x, h/2, z); m.castShadow = m.receiveShadow = m.isMapObj = true;
                scene.add(m);
            };

            if(map === 'desert') {
                for(let i=0; i<15; i++) addObj(8, 6, 8, Math.random()*120-60, Math.random()*120-60);
            } else {
                for(let i=0; i<40; i++) addObj(2, 8, 12, Math.random()*150-75, Math.random()*150-75);
            }
        }

        // AUDIO ENGINE
        const aCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, t, d, v=1) {
            if(aCtx.state === 'suspended') aCtx.resume();
            const o = aCtx.createOscillator(), g = aCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, aCtx.currentTime);
            g.gain.setValueAtTime(config.vol * 0.1 * v, aCtx.currentTime);
            o.connect(g); g.connect(aCtx.destination);
            o.start(); o.stop(aCtx.currentTime + d);
        }

        // NETWORK DATA
        function initNetworkStats() {
            onValue(ref(db, 'players'), s => {
                const count = s.exists() ? Object.keys(s.val()).length : 0;
                document.getElementById('hud-online').innerText = `ONLINE: ${count}`;
                document.getElementById('lobby-stats').innerText = `PING: ${ping}ms | ONLINE: ${count}`;
            });
            setInterval(() => {
                const start = Date.now();
                update(ref(db, `players/${auth.currentUser.uid}`), { t: serverTimestamp() }).then(() => {
                    ping = Date.now() - start;
                    document.getElementById('hud-ping').innerText = `PING: ${ping}ms`;
                });
            }, 3000);
        }

        // PLAYER MODEL BUILDER (EYES, ARMS, LEGS)
        function createRemotePlayer() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshStandardMaterial({color: 0x2563eb}));
            body.position.y = 1.1; group.add(body);

            const eyeM = new THREE.MeshStandardMaterial({color: 0x000});
            const eyeL = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.1, 0.1), eyeM);
            eyeL.position.set(-0.15, 2, -0.3); group.add(eyeL);
            const eyeR = eyeL.clone(); eyeR.position.x = 0.15; group.add(eyeR);

            const armG = new THREE.BoxGeometry(0.15, 0.7, 0.15);
            const armL = new THREE.Mesh(armG, new THREE.MeshStandardMaterial({color: 0x2563eb}));
            armL.position.set(-0.5, 1.3, 0); group.add(armL);
            const armR = armL.clone(); armR.position.x = 0.5; group.add(armR);

            const rGun = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.6), new THREE.MeshStandardMaterial({color: 0x000}));
            rGun.position.set(0.5, 1.2, -0.4); group.add(rGun);

            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 128;
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: tex}));
            sprite.position.y = 3.2; sprite.scale.set(2, 1, 1);
            group.add(sprite);

            return { group, hit: body, ctx: canvas.getContext('2d'), tex };
        }

        // NETPLAY
        function startSync() {
            const myRef = ref(db, `players/${auth.currentUser.uid}`);
            onDisconnect(myRef).remove();

            onValue(ref(db, 'players'), snap => {
                const data = snap.val(); if(!data) return;
                for(let id in data) {
                    const d = data[id];
                    if(id === auth.currentUser.uid) {
                        if(d.hp < myHP) {
                            myHP = d.hp; flashRed(); updateHUD();
                            if(myHP <= 0 && !isDead) { isDead = true; document.getElementById('scr-death').style.display='flex'; controls.unlock(); handleDeath(); }
                        }
                        continue;
                    }
                    if(d.map !== activeSector) {
                        if(enemies[id]) { scene.remove(enemies[id].group); delete enemies[id]; }
                        continue;
                    }

                    if(!enemies[id]) {
                        enemies[id] = createRemotePlayer();
                        scene.add(enemies[id].group);
                    }
                    const e = enemies[id];
                    e.group.position.set(d.x, d.y, d.z);
                    e.group.rotation.y = d.ry;
                    
                    const ctx = e.ctx; ctx.clearRect(0,0,256,128);
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 26px Arial'; ctx.textAlign = 'center';
                    ctx.fillText(d.nick || 'PLAYER', 128, 40);
                    ctx.fillStyle = '#1e293b'; ctx.fillRect(50, 60, 156, 12);
                    ctx.fillStyle = d.hp > 30 ? '#4ade80' : '#ef4444';
                    ctx.fillRect(50, 60, (d.hp/100)*156, 12);
                    e.tex.needsUpdate = true;
                }
                for(let id in enemies) { if(!data[id]) { scene.remove(enemies[id].group); delete enemies[id]; } }
            });
        }

        function flashRed() {
            document.getElementById('dmg-vignette').style.opacity = '1';
            playSfx(100, 'sine', 0.2, 2);
            setTimeout(() => document.getElementById('dmg-vignette').style.opacity = '0', 100);
        }

        function updateHUD() {
            document.getElementById('hud-hp-txt').innerText = `${Math.ceil(myHP)} HP`;
            document.getElementById('hp-fill').style.width = myHP + '%';
            document.getElementById('ammo-val').innerText = myAmmo;
        }

        async function handleDeath() {
            totalDeaths++;
            await update(ref(db, `users/${auth.currentUser.uid}`), { deaths: totalDeaths });
        }

        // GAMEPLAY ACTIONS
        document.getElementById('do-deploy').onclick = () => {
            if(aCtx.state === 'suspended') aCtx.resume();
            buildEnvironment(activeSector);
            view('game'); document.getElementById('hud').style.display = 'block';
            controls.lock();
            camera.position.set(Math.random()*40-20, 1.7, Math.random()*40-20);
            startSync();
        };

        const ray = new THREE.Raycaster();
        window.onmousedown = (e) => {
            if(!controls.isLocked || isDead || isReloading || e.button !== 0) return;
            if(myAmmo <= 0) { reload(); return; }

            myAmmo--; updateHUD();
            playSfx(200, 'sawtooth', 0.08);
            camera.rotation.x += 0.02; // Kickback

            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            for(let id in enemies) {
                if(ray.intersectObject(enemies[id].hit).length > 0) {
                    playSfx(1000, 'sine', 0.05);
                    runTransaction(ref(db, `players/${id}/hp`), cur => {
                        const next = (cur || 100) - 20;
                        if(next <= 0) {
                            totalKills++; 
                            update(ref(db, `users/${auth.currentUser.uid}`), { kills: totalKills });
                        }
                        return next;
                    });
                }
            }
        };

        function reload() {
            if(isReloading || myAmmo === maxAmmo) return;
            isReloading = true;
            document.getElementById('reload-tip').style.display = 'block';
            playSfx(400, 'square', 0.5);
            gunG.position.y -= 0.5;
            setTimeout(() => {
                myAmmo = maxAmmo;
                isReloading = false;
                document.getElementById('reload-tip').style.display = 'none';
                updateHUD();
                gunG.position.y += 0.5;
            }, 1800);
        }

        // CONTROLS & LOOP
        const keys = {};
        window.onkeydown = e => { keys[e.code] = true; if(e.code === 'KeyR') reload(); if(e.code === 'Escape' && !isDead) document.getElementById('esc-menu').style.display='flex'; };
        window.onkeyup = e => keys[e.code] = false;

        document.getElementById('esc-resume').onclick = () => { controls.lock(); document.getElementById('esc-menu').style.display='none'; };
        document.getElementById('esc-lobby').onclick = () => location.reload();

        const clock = new THREE.Clock();
        let lastNetUpdate = 0, bStep = 0;

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            if(controls.isLocked && !isDead) {
                const spd = 7 * dt;
                let isMoving = false;
                if(keys['KeyW']) { controls.moveForward(spd); isMoving = true; }
                if(keys['KeyS']) { controls.moveForward(-spd); isMoving = true; }
                if(keys['KeyA']) { controls.moveRight(-spd); isMoving = true; }
                if(keys['KeyD']) { controls.moveRight(spd); isMoving = true; }

                // TRASKA KAMERI (BOBBING)
                if(isMoving) {
                    bStep += dt * 10;
                    camera.position.y = 1.7 + Math.sin(bStep) * 0.05;
                } else {
                    camera.position.y = THREE.MathUtils.lerp(camera.position.y, 1.7, 0.1);
                }

                camera.position.x = THREE.MathUtils.clamp(camera.position.x, -95, 95);
                camera.position.z = THREE.MathUtils.clamp(camera.position.z, -95, 95);

                gunG.position.copy(camera.position);
                gunG.quaternion.copy(camera.quaternion);

                // NETWORK SYNC THROTTLE
                if(Date.now() - lastNetUpdate > 33) {
                    update(ref(db, `players/${auth.currentUser.uid}`), {
                        x: camera.position.x, y: camera.position.y-1.7, z: camera.position.z,
                        ry: camera.rotation.y, nick: auth.currentUser.displayName, hp: myHP, map: activeSector
                    });
                    lastNetUpdate = Date.now();
                }
            }
            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
