<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUTCH | ULTIMATE WARFARE v23.0</title>
    <style>
        /* ГЛОБАЛЬНЫЕ СТИЛИ И ПЕРЕМЕННЫЕ */
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --bg-dark: #020617;
            --glass-bg: rgba(15, 23, 42, 0.95);
            --border-glow: rgba(37, 99, 235, 0.3);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            color: #ffffff;
            font-family: var(--font-main);
        }

        /* ЭКРАНЫ ЗАГРУЗКИ И АВТОРИЗАЦИИ */
        .screen-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            transition: opacity 0.8s ease, visibility 0.8s;
        }

        .auth-container {
            width: 550px;
            padding: 60px;
            background: var(--glass-bg);
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(30px);
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), 0 0 40px var(--border-glow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: "";
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(transparent, var(--primary), transparent 30%);
            animation: rotateGlow 6s linear infinite;
            z-index: -1;
            opacity: 0.3;
        }

        @keyframes rotateGlow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        h1.logo {
            font-size: 90px;
            font-weight: 950;
            letter-spacing: -8px;
            margin-bottom: 0;
            background: linear-gradient(to bottom, #fff 40%, #64748b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
        }

        .version-badge {
            display: inline-block;
            padding: 5px 15px;
            background: var(--primary);
            border-radius: 10px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 2px;
            margin-bottom: 40px;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 800;
            color: var(--secondary);
            margin-bottom: 8px;
            margin-left: 15px;
            text-transform: uppercase;
        }

        input {
            width: 100%;
            padding: 22px 25px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
            outline: none;
        }

        input:focus {
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 25px rgba(37, 99, 235, 0.2);
        }

        .main-btn {
            width: 100%;
            padding: 22px;
            border-radius: 20px;
            border: none;
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 15px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-btn:hover {
            transform: translateY(-5px) scale(1.02);
            filter: brightness(1.2);
        }

        /* HUD ЭЛЕМЕНТЫ */
        #game-hud {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .stats-top {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }

        .hud-card {
            background: rgba(0,0,0,0.8);
            padding: 12px 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            font-size: 14px;
            font-weight: 800;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-display {
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 350px;
        }

        .bar-container {
            width: 100%;
            height: 12px;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 10px;
        }

        #hp-bar-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--danger), #ff8080);
            transition: width 0.3s ease;
            box-shadow: 0 0 20px var(--danger);
        }

        .ammo-display {
            position: absolute;
            bottom: 50px;
            right: 50px;
            text-align: right;
        }

        #ammo-count {
            font-size: 80px;
            font-weight: 900;
            line-height: 0.8;
            letter-spacing: -5px;
        }

        /* ЧАТ */
        #chat-wrapper {
            position: absolute;
            bottom: 150px;
            left: 50px;
            width: 400px;
            height: 250px;
            display: flex;
            flex-direction: column;
        }

        #chat-messages {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 5px;
            padding: 10px;
        }

        .msg {
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 14px;
            width: fit-content;
            border-left: 4px solid var(--primary);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #chat-input {
            margin-top: 10px;
            pointer-events: auto;
            display: none;
        }

        /* АДМИН ПАНЕЛЬ */
        #admin-modal {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .admin-box {
            width: 900px;
            background: #0f172a;
            border: 2px solid var(--primary);
            border-radius: 30px;
            padding: 40px;
        }

        .player-list {
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 10px;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* ПЕРЕКРЕСТИЕ */
        .crosshair {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            pointer-events: none;
        }

        .crosshair::before, .crosshair::after {
            content: "";
            position: absolute;
            background: #fff;
        }

        .crosshair::before { width: 2px; height: 20px; left: 9px; }
        .crosshair::after { width: 20px; height: 2px; top: 9px; }

        /* ЭФФЕКТЫ */
        #blood-fx {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 40%, rgba(239, 68, 68, 0.4) 100%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body oncontextmenu="return false;"> <div id="blood-fx"></div>

    <div id="scr-auth" class="screen-overlay">
        <div class="auth-container">
            <h1 class="logo">CLUTCH</h1>
            <div class="version-badge">BETA v23.0.4</div>
            
            <div class="input-group">
                <label>CALLSIGN (ИДЕНТИФИКАТОР)</label>
                <input type="text" id="auth-nick" placeholder="Введите ваш позывной...">
            </div>
            
            <div class="input-group">
                <label>ENCRYPTION KEY (ПАРОЛЬ)</label>
                <input type="password" id="auth-pass" placeholder="••••••••">
            </div>

            <button class="main-btn btn-primary" id="btn-login">ПОДКЛЮЧИТЬСЯ К СЕТИ</button>
            <button class="main-btn btn-secondary" id="btn-reg">РЕГИСТРАЦИЯ НОВОГО ОБЪЕКТА</button>
            
            <p id="auth-status" style="margin-top: 20px; font-size: 12px; color: var(--danger); font-weight: 800; text-transform: uppercase;"></p>
        </div>
    </div>

    <div id="scr-lobby" class="screen-overlay hidden">
        <div class="auth-container" style="width: 700px;">
            <div style="text-align: left; margin-bottom: 40px;">
                <h2 id="ui-username" style="font-size: 50px; letter-spacing: -2px;">OPERATOR</h2>
                <div style="color: var(--primary); font-weight: 900; letter-spacing: 5px;">СТАТУС: В СЕТИ</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 12px; color: var(--secondary);">ЛИКВИДИРОВАНО</div>
                    <div id="stat-kills" style="font-size: 40px; font-weight: 900;">0</div>
                </div>
                <div style="background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 12px; color: var(--secondary);">ПОТЕРЬ</div>
                    <div id="stat-deaths" style="font-size: 40px; font-weight: 900;">0</div>
                </div>
            </div>

            <button class="main-btn btn-primary" id="btn-deploy" style="height: 100px; font-size: 30px;">НАЧАТЬ ВЫСАДКУ</button>
            <button class="main-btn btn-secondary" id="btn-logout">ОТКЛЮЧИТЬСЯ</button>
        </div>
    </div>

    <div id="game-hud">
        <div class="stats-top">
            <div class="hud-card">
                <span style="color: var(--primary);">●</span>
                <span id="hud-ping">PING: 0ms</span>
            </div>
            <div class="hud-card">
                <span style="color: var(--success);">●</span>
                <span id="hud-online">PLAYERS: 1</span>
            </div>
        </div>

        <div id="chat-wrapper">
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Введите сообщение... (ENTER)">
        </div>

        <div class="health-display">
            <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 18px;">
                <span>HEALTH SYSTEM</span>
                <span id="hp-value">100 / 100</span>
            </div>
            <div class="bar-container">
                <div id="hp-bar-fill"></div>
            </div>
        </div>

        <div class="ammo-display">
            <div style="font-size: 14px; font-weight: 900; color: var(--secondary); letter-spacing: 3px;">MAGAZINE</div>
            <div id="ammo-count">12</div>
        </div>

        <div class="crosshair"></div>
    </div>

    <div id="admin-modal">
        <div class="admin-box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 30px;">NETWORK COMMAND CENTER</h2>
                <div style="padding: 5px 15px; border: 1px solid var(--primary); color: var(--primary); border-radius: 10px; font-size: 12px; font-weight: 900;">ROOT ACCESS</div>
            </div>
            <div class="player-list" id="admin-player-list">
                </div>
            <button class="main-btn btn-secondary" style="margin-top: 30px;" onclick="document.getElementById('admin-modal').style.display='none'">ВЫХОД (P)</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, onDisconnect, update, remove, get, set, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ==========================================
        // БЛОК ЗАЩИТЫ (F12, ПКМ, Ctrl+U)
        // ==========================================
        window.addEventListener('keydown', function(e) {
            if (e.key === "F12" || 
                (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C")) || 
                (e.ctrlKey && e.key === "u")) {
                e.preventDefault();
                alert("ACCESS DENIED: SECURITY PROTOCOL ACTIVE");
                return false;
            }
        });

        // ==========================================
        // FIREBASE КОНФИГУРАЦИЯ (ТВОИ ДАННЫЕ)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDRH07hc8tMsG1TvMyHOptrOTEJDp_4kE8",
            authDomain: "clutch-shuter.firebaseapp.com",
            databaseURL: "https://clutch-shuter-default-rtdb.firebaseio.com",
            projectId: "clutch-shuter",
            storageBucket: "clutch-shuter.firebasestorage.app",
            messagingSenderId: "224141175517",
            appId: "1:224141175517:web:671a68999f8cf6a2dc4934",
            measurementId: "G-SQ1CQHE15V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // ==========================================
        // ГЕЙМПЛЕЙНЫЕ ПЕРЕМЕННЫЕ
        // ==========================================
        let myHP = 100, myAmmo = 12, isDead = false, isReloading = false;
        let lastAction = Date.now();
        const AFK_TIMEOUT = 30000; // 30 секунд
        const otherPlayers = {};
        const clock = new THREE.Clock();
        let isChatting = false;

        // ==========================================
        // ГРАФИЧЕСКОЕ ЯДРО (THREE.JS)
        // ==========================================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020617);
        scene.fog = new THREE.FogExp2(0x020617, 0.015);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Освещение
        const ambLight = new THREE.AmbientLight(0xffffff, 0.3);
        scene.add(ambLight);

        const sun = new THREE.DirectionalLight(0x3b82f6, 1);
        sun.position.set(100, 200, 100);
        sun.castShadow = true;
        scene.add(sun);

        // Пол
        const floorGeo = new THREE.PlaneGeometry(2000, 2000);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x0f172a, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Сетка
        const grid = new THREE.GridHelper(2000, 100, 0x1e293b, 0x0f172a);
        scene.add(grid);

        // Управление
        const controls = new PointerLockControls(camera, document.body);

        // Оружие в руках
        const weaponGroup = new THREE.Group();
        const gunBody = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.7), new THREE.MeshStandardMaterial({color: 0x111111}));
        gunBody.position.set(0.3, -0.3, -0.5);
        weaponGroup.add(gunBody);
        scene.add(weaponGroup);

        // ==========================================
        // ЗВУКОВОЙ ДВИЖОК
        // ==========================================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration, volume = 0.1) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // ==========================================
        // ЛОГИКА АВТОРИЗАЦИИ
        // ==========================================
        const authStatus = document.getElementById('auth-status');

        document.getElementById('btn-login').onclick = async () => {
            const nick = document.getElementById('auth-nick').value;
            const pass = document.getElementById('auth-pass').value;
            if(!nick || !pass) return;

            try {
                const email = nick.includes('@') ? nick : `${nick.toLowerCase()}@clutch.io`;
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                authStatus.innerText = "ОШИБКА: ОБЪЕКТ НЕ НАЙДЕН ИЛИ КЛЮЧ НЕВЕРЕН";
            }
        };

        document.getElementById('btn-reg').onclick = async () => {
            const nick = document.getElementById('auth-nick').value;
            const pass = document.getElementById('auth-pass').value;
            if(nick.length < 3) { authStatus.innerText = "СЛИШКОМ КОРОТКИЙ ПОЗЫВНОЙ"; return; }

            try {
                const email = `${nick.toLowerCase()}@clutch.io`;
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(res.user, { displayName: nick });
                await set(ref(db, `users/${res.user.uid}`), { kills: 0, deaths: 0, created: serverTimestamp() });
                authStatus.style.color = "var(--success)";
                authStatus.innerText = "ОБЪЕКТ ЗАРЕГИСТРИРОВАН. ВХОДИТЕ.";
            } catch (error) {
                authStatus.innerText = "ОШИБКА: ИМЯ ЗАНЯТО ИЛИ ПАРОЛЬ СЛАБЫЙ";
            }
        };

        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('scr-auth').classList.add('hidden');
                document.getElementById('scr-lobby').classList.remove('hidden');
                document.getElementById('ui-username').innerText = user.displayName.toUpperCase();
                loadStats(user.uid);
                initNetwork();
            } else {
                document.getElementById('scr-auth').classList.remove('hidden');
                document.getElementById('scr-lobby').classList.add('hidden');
            }
        });

        async function loadStats(uid) {
            const snap = await get(ref(db, `users/${uid}`));
            if(snap.exists()) {
                document.getElementById('stat-kills').innerText = snap.val().kills || 0;
                document.getElementById('stat-deaths').innerText = snap.val().deaths || 0;
            }
        }

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // ==========================================
        // СЕТЕВАЯ СИНХРОНИЗАЦИЯ
        // ==========================================
        function initNetwork() {
            const pRef = ref(db, `players/${auth.currentUser.uid}`);
            
            // Удаление при выходе
            onDisconnect(pRef).remove();

            // Чат
            onValue(ref(db, 'global_chat'), snap => {
                const data = snap.val();
                if(!data) return;
                const chatMsgs = document.getElementById('chat-messages');
                chatMsgs.innerHTML = '';
                const entries = Object.values(data).slice(-6);
                entries.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'msg';
                    div.innerHTML = `<b style="color:var(--primary)">${m.user}:</b> ${m.text}`;
                    chatMsgs.appendChild(div);
                });
            });

            // Другие игроки
            onValue(ref(db, 'players'), snap => {
                const all = snap.val() || {};
                document.getElementById('hud-online').innerText = `PLAYERS: ${Object.keys(all).length}`;

                // Админка для dqmjrka
                if(auth.currentUser.displayName === 'dqmjrka') {
                    const adminList = document.getElementById('admin-player-list');
                    adminList.innerHTML = '';
                    for(let id in all) {
                        const row = document.createElement('div');
                        row.className = 'player-row';
                        row.innerHTML = `
                            <span><b>${all[id].nick}</b> [ID: ${id.substring(0,5)}]</span>
                            <button class="main-btn btn-secondary" style="width:100px; padding:10px;" onclick="window.kickPlayer('${id}')">KICK</button>
                        `;
                        adminList.appendChild(row);
                    }
                }

                for(let id in all) {
                    if(id === auth.currentUser.uid) {
                        // Если нас удалили (кикнули)
                        if(all[id] === null) location.reload();
                        
                        // Если в нас попали
                        if(all[id].hp < myHP) {
                            myHP = all[id].hp;
                            onDamageReceived();
                        }
                        continue;
                    }

                    if(!otherPlayers[id]) {
                        otherPlayers[id] = createPlayerModel(all[id].nick);
                    }
                    
                    const p = otherPlayers[id];
                    p.mesh.position.lerp(new THREE.Vector3(all[id].x, all[id].y, all[id].z), 0.2);
                    p.mesh.rotation.y = all[id].ry;
                    updateNameplate(p, all[id].hp);
                }

                // Удаление ушедших
                for(let id in otherPlayers) {
                    if(!all[id]) {
                        scene.remove(otherPlayers[id].mesh);
                        delete otherPlayers[id];
                    }
                }
            });
        }

        window.kickPlayer = (id) => {
            remove(ref(db, `players/${id}`));
        };

        function createPlayerModel(name) {
            const group = new THREE.Group();
            
            // Тело
            const body = new THREE.Mesh(
                new THREE.CapsuleGeometry(0.4, 1.2, 4, 8),
                new THREE.MeshStandardMaterial({ color: 0xef4444 })
            );
            body.position.y = 1;
            group.add(body);

            // Имя
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
            sprite.position.y = 2.5;
            sprite.scale.set(2, 0.5, 1);
            group.add(sprite);

            scene.add(group);
            return { mesh: group, ctx, tex, name };
        }

        function updateNameplate(p, hp) {
            const c = p.ctx;
            c.clearRect(0,0,256,64);
            c.fillStyle = 'white';
            c.font = 'bold 32px Arial';
            c.textAlign = 'center';
            c.fillText(p.name, 128, 30);
            
            // Полоска HP
            c.fillStyle = 'rgba(0,0,0,0.5)';
            c.fillRect(64, 40, 128, 10);
            c.fillStyle = hp > 30 ? '#22c55e' : '#ef4444';
            c.fillRect(64, 40, (hp/100)*128, 10);
            p.tex.needsUpdate = true;
        }

        // ==========================================
        // БОЕВАЯ СИСТЕМА
        // ==========================================
        function onDamageReceived() {
            playSound(100, 'sine', 0.2, 0.5);
            document.getElementById('blood-fx').style.opacity = "1";
            setTimeout(() => document.getElementById('blood-fx').style.opacity = "0", 100);
            updateHUD();
            if(myHP <= 0 && !isDead) {
                isDead = true;
                alert("ВЫ ПОГИБЛИ. ПЕРЕЗАГРУЗКА...");
                location.reload();
            }
        }

        const raycaster = new THREE.Raycaster();
        window.addEventListener('mousedown', (e) => {
            if(!controls.isLocked || isDead || isReloading || isChatting) return;
            if(e.button === 0) { // ЛКМ
                if(myAmmo <= 0) { doReload(); return; }
                
                myAmmo--;
                lastAction = Date.now();
                updateHUD();
                playSound(400, 'sawtooth', 0.1, 0.2);
                
                // Отдача
                weaponGroup.position.z += 0.1;

                // Проверка попадания
                raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
                for(let id in otherPlayers) {
                    const intersects = raycaster.intersectObject(otherPlayers[id].mesh, true);
                    if(intersects.length > 0) {
                        playSound(800, 'sine', 0.05, 0.3);
                        damagePlayer(id);
                    }
                }
            }
        });

        function damagePlayer(id) {
            runTransaction(ref(db, `players/${id}/hp`), (current) => {
                const next = (current || 100) - 20;
                if(next <= 0) {
                    // Засчитать килл
                    runTransaction(ref(db, `users/${auth.currentUser.uid}/kills`), c => (c || 0) + 1);
                }
                return next;
            });
        }

        function doReload() {
            if(isReloading) return;
            isReloading = true;
            playSound(200, 'square', 0.5, 0.2);
            weaponGroup.rotation.x = -0.5;
            setTimeout(() => {
                myAmmo = 12;
                isReloading = false;
                weaponGroup.rotation.x = 0;
                updateHUD();
            }, 1500);
        }

        // ==========================================
        // КЛАВИАТУРА И УПРАВЛЕНИЕ
        // ==========================================
        const keys = {};
        window.onkeydown = e => {
            keys[e.code] = true;
            if(e.code === 'Enter') toggleChat();
            if(e.code === 'KeyR') doReload();
            if(e.code === 'KeyP' && auth.currentUser.displayName === 'dqmjrka') {
                document.getElementById('admin-modal').style.display = 'flex';
                controls.unlock();
            }
        };
        window.onkeyup = e => keys[e.code] = false;

        function toggleChat() {
            const input = document.getElementById('chat-input');
            if(!isChatting) {
                isChatting = true;
                input.style.display = 'block';
                input.focus();
                controls.unlock();
            } else {
                if(input.value.trim()) {
                    const chatRef = ref(db, `global_chat/${Date.now()}`);
                    set(chatRef, {
                        user: auth.currentUser.displayName,
                        text: input.value,
                        time: serverTimestamp()
                    });
                }
                input.value = '';
                input.style.display = 'none';
                isChatting = false;
                controls.lock();
            }
        }

        document.getElementById('btn-deploy').onclick = () => {
            document.getElementById('scr-lobby').classList.add('hidden');
            document.getElementById('game-hud').style.display = 'block';
            controls.lock();
            
            // Спавн
            camera.position.set(Math.random()*10, 1.7, Math.random()*10);
            updateHUD();
            
            // Инициализация в БД
            update(ref(db, `players/${auth.currentUser.uid}`), {
                nick: auth.currentUser.displayName,
                hp: 100,
                x: camera.position.x,
                y: camera.position.y,
                z: camera.position.z,
                ry: camera.rotation.y
            });
        };

        function updateHUD() {
            document.getElementById('hp-value').innerText = `${myHP} / 100`;
            document.getElementById('hp-bar-fill').style.width = myHP + "%";
            document.getElementById('ammo-count').innerText = myAmmo;
        }

        // ==========================================
        // ОСНОВНОЙ ЦИКЛ (RENDER LOOP)
        // ==========================================
        let lastSync = 0;
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            if(controls.isLocked && !isDead) {
                // Проверка AFK
                if(Date.now() - lastAction > AFK_TIMEOUT) {
                    location.reload();
                }

                // Движение
                const speed = 10 * dt;
                if(keys['KeyW']) { controls.moveForward(speed); lastAction = Date.now(); }
                if(keys['KeyS']) { controls.moveForward(-speed); lastAction = Date.now(); }
                if(keys['KeyA']) { controls.moveRight(-speed); lastAction = Date.now(); }
                if(keys['KeyD']) { controls.moveRight(speed); lastAction = Date.now(); }

                // Плавное оружие
                weaponGroup.position.copy(camera.position);
                weaponGroup.quaternion.copy(camera.quaternion);
                weaponGroup.position.z = THREE.MathUtils.lerp(weaponGroup.position.z, 0, 0.1);

                // Синхронизация с БД (30 раз в секунду)
                if(Date.now() - lastSync > 33) {
                    update(ref(db, `players/${auth.currentUser.uid}`), {
                        x: camera.position.x,
                        y: camera.position.y - 1.7,
                        z: camera.position.z,
                        ry: camera.rotation.y,
                        hp: myHP
                    });
                    lastSync = Date.now();
                }
            }

            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
