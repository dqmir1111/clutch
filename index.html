<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUTCH | OMEGA STRIKE v22.8</title>
    <style>
        /** * ЦВЕТОВАЯ ПАЛИТРА И ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
         * Используем современные CSS-переменные для легкой настройки тем.
         */
        :root { 
            --p: #2563eb; 
            --s: #64748b; 
            --d: #ef4444; 
            --bg: #020617; 
            --glass: rgba(15, 23, 42, 0.98); 
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        /* ОБНУЛЕНИЕ И БАЗОВЫЕ СТИЛИ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; }
        body, html { 
            width: 100%; height: 100%; overflow: hidden; 
            background: var(--bg); color: #fff; 
            user-select: none; -webkit-user-drag: none;
        }

        /* ЭКРАНЫ И ОВЕРЛЕИ */
        .overlay {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            z-index: 2000; background: radial-gradient(circle at center, #1e293b, #020617);
            transition: all 0.5s ease-in-out;
        }

        .card {
            width: 650px; padding: 60px; background: var(--glass);
            border-radius: 50px; border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(45px); text-align: center;
            box-shadow: 0 60px 150px rgba(0,0,0,1);
            animation: cardEnter 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes cardEnter {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        h1 { font-size: 85px; font-weight: 950; letter-spacing: -7px; margin-bottom: 5px; text-transform: uppercase; line-height: 0.9; }
        .tagline { color: var(--accent); font-size: 13px; letter-spacing: 9px; text-transform: uppercase; margin-bottom: 45px; font-weight: 800; }

        /* ИНПУТЫ И КНОПКИ */
        input, select {
            width: 100%; padding: 25px; margin-bottom: 20px; border-radius: 25px;
            border: 2px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.7);
            color: #fff; font-size: 18px; outline: none; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input:focus { border-color: var(--p); box-shadow: 0 0 35px rgba(37, 99, 235, 0.45); background: rgba(0,0,0,0.9); }

        .btn-row { display: flex; gap: 20px; margin-top: 20px; }
        button {
            flex: 1; padding: 25px; border-radius: 25px; border: none;
            font-weight: 900; cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-size: 15px; text-transform: uppercase; letter-spacing: 2px;
        }
        .btn-p { background: var(--p); color: #fff; box-shadow: 0 15px 35px rgba(37, 99, 235, 0.4); }
        .btn-s { background: rgba(255,255,255,0.07); color: #fff; border: 1px solid rgba(255,255,255,0.05); }
        .btn-d { background: var(--d); color: #fff; box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3); }
        button:hover { transform: translateY(-7px); filter: brightness(1.3); }
        button:active { transform: translateY(-2px); filter: brightness(0.9); }

        /* КАРТЫ */
        .map-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin: 35px 0; }
        .map-card { 
            padding: 35px; border-radius: 35px; border: 2px solid rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .map-card.active { border-color: var(--p); background: rgba(37, 99, 235, 0.2); transform: scale(1.04); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* ГЕЙМПЛЕЙ HUD */
        #hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        .hud-top { position: absolute; top: 40px; width: 100%; display: flex; justify-content: center; gap: 30px; }
        .hud-pill { background: rgba(0,0,0,0.9); padding: 14px 28px; border-radius: 40px; font-size: 14px; font-weight: 900; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); color: #fff; }

        /* ЧАТ */
        #chat-sys {
            position: absolute; bottom: 200px; left: 50px; width: 420px; height: 280px;
            display: flex; flex-direction: column; pointer-events: none;
        }
        #chat-logs { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        .msg-line { background: rgba(0,0,0,0.7); padding: 10px 18px; border-radius: 14px; font-size: 15px; width: fit-content; border-left: 4px solid var(--accent); animation: msgEnter 0.4s ease-out; }
        @keyframes msgEnter { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        #chat-input { 
            background: rgba(0,0,0,0.95); border: 2px solid var(--p); color: #fff; padding: 16px; border-radius: 18px;
            width: 100%; pointer-events: auto; display: none; outline: none; font-size: 16px; box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }

        /* ПОКАЗАТЕЛИ */
        .health-container { position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); width: 500px; text-align: center; }
        .health-bar { width: 100%; height: 20px; background: rgba(0,0,0,0.8); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.25); margin-top: 15px; }
        #health-val { width: 100%; height: 100%; background: linear-gradient(90deg, #ef4444, #fca5a5); transition: 0.3s cubic-bezier(0.1, 0.9, 0.2, 1); box-shadow: 0 0 30px var(--d); }

        .ammo-container { position: absolute; bottom: 70px; right: 100px; text-align: right; }
        #ammo-num { font-size: 100px; font-weight: 950; line-height: 0.75; letter-spacing: -5px; text-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        /* ПАНЕЛЬ УПРАВЛЕНИЯ (ADMIN) */
        #admin-ui {
            position: absolute; inset: 0; background: rgba(0,0,0,0.96); z-index: 4500;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px);
        }
        .admin-wrap { width: 850px; background: #0f172a; border-radius: 45px; padding: 55px; border: 4px solid var(--p); box-shadow: 0 0 150px rgba(37, 99, 235, 0.25); }
        .player-table { max-height: 500px; overflow-y: auto; margin-top: 30px; border-radius: 25px; background: rgba(0,0,0,0.4); padding: 10px; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 22px; border-bottom: 1px solid rgba(255,255,255,0.06); }

        /* МОДАЛКИ ПОЛНЫЕ */
        .full-modal { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.94); z-index: 3800; display: none; align-items: center; justify-content: center; backdrop-filter: blur(25px); }

        /* ВИЗУАЛЬНЫЕ ЭФФЕКТЫ */
        #dot { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px #fff; opacity: 0.8; }
        #damage-fx { position: absolute; inset: 0; background: radial-gradient(circle, transparent 35%, rgba(239,68,68,0.6) 100%); pointer-events: none; opacity: 0; transition: 0.12s; z-index: 1999; }

        .blink { animation: blinkAnim 0.6s infinite; }
        @keyframes blinkAnim { 50% { opacity: 0; } }
        .hidden { display: none !important; }

        /* СКРОЛЛБАР */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--s); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="damage-fx"></div>

    <div id="scr-auth" class="overlay">
        <div class="card">
            <h1>CLUTCH</h1>
            <div class="tagline">OMEGA STRIKE v22.8</div>
            <input type="text" id="auth-user" placeholder="Идентификатор (Позывной)">
            <input type="password" id="auth-pass" placeholder="Ключ шифрования">
            <div class="btn-row">
                <button class="btn-p" id="do-login">ПОДКЛЮЧИТЬСЯ</button>
                <button class="btn-s" id="do-reg">РЕГИСТРАЦИЯ</button>
            </div>
            <p id="auth-log" style="color:var(--d); margin-top:30px; font-weight:900; font-size: 13px; text-transform: uppercase;"></p>
        </div>
    </div>

    <div id="scr-lobby" class="overlay hidden">
        <div class="card">
            <h1 id="ui-nick">ОПЕРАТОР</h1>
            <div class="tagline" id="ui-net-info">КАНАЛ СВЯЗИ АКТИВЕН</div>
            
            <div class="map-selector">
                <div class="map-card active" data-map="legacy">
                    <div style="height:110px; background:linear-gradient(135deg, #15803d, #22c55e); border-radius:25px; margin-bottom:15px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:22px; color:#fff;">ALPHA</div>
                    <b>ПОЛИГОН "ГРАСС"</b>
                </div>
                <div class="map-card" data-map="night">
                    <div style="height:110px; background:linear-gradient(135deg, #020617, #1e293b); border-radius:25px; margin-bottom:15px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:22px; color:#3b82f6;">VOID</div>
                    <b>ЗОНА "ПОЛНОЧЬ"</b>
                </div>
            </div>

            <button class="btn-p" id="go-deploy" style="height:130px; font-size:35px; margin-bottom:25px;">ВЫСАДКА</button>
            <div class="btn-row">
                <button class="btn-s" id="go-profile">ДОСЬЕ</button>
                <button class="btn-s" id="go-settings">ОПЦИИ</button>
            </div>
            <button class="btn-s" id="go-logout" style="width:100%; margin-top:25px; opacity:0.5; font-size:11px; letter-spacing: 5px;">DISCONNECT</button>
        </div>
    </div>

    <div id="scr-profile" class="full-modal">
        <div class="card">
            <h2 style="font-size:45px; margin-bottom:35px; letter-spacing: -2px;">ЛИЧНОЕ ДЕЛО</h2>
            <div style="display: flex; gap: 30px; margin-bottom:45px;">
                <div class="map-card" style="flex:1; cursor:default; border-color:var(--accent);">
                    <div style="font-size:12px; color:var(--s); margin-bottom:10px;">ПОДТВЕРЖДЕНО</div>
                    <h2 id="st-kills" style="font-size:60px; color:var(--accent); line-height:1;">0</h2>
                </div>
                <div class="map-card" style="flex:1; cursor:default; border-color:var(--d);">
                    <div style="font-size:12px; color:var(--s); margin-bottom:10px;">ПОТЕРЯНО</div>
                    <h2 id="st-deaths" style="font-size:60px; color:var(--d); line-height:1;">0</h2>
                </div>
            </div>
            <button class="btn-p" onclick="this.closest('.full-modal').style.display='none'">ВЕРНУТЬСЯ В ШТАБ</button>
        </div>
    </div>

    <div id="scr-settings" class="full-modal">
        <div class="card">
            <h2 style="font-size:45px; margin-bottom:35px; letter-spacing: -2px;">ПАРАМЕТРЫ</h2>
            <div style="text-align: left; padding: 0 30px;">
                <div style="margin-bottom:30px;">
                    <label style="color:var(--s); font-size:13px; font-weight:800; letter-spacing: 1px;">SENSITIVITY (МЫШЬ)</label>
                    <input type="range" id="val-sens" min="0.1" max="5.0" step="0.1" style="width:100%; margin-top:15px; cursor: pointer;">
                </div>
                <div style="margin-bottom:30px;">
                    <label style="color:var(--s); font-size:13px; font-weight:800; letter-spacing: 1px;">VOLUME (ЗВУК)</label>
                    <input type="range" id="val-vol" min="0" max="1" step="0.1" style="width:100%; margin-top:15px; cursor: pointer;">
                </div>
            </div>
            <button class="btn-p" id="save-cfg">СОХРАНИТЬ ИЗМЕНЕНИЯ</button>
        </div>
    </div>

    <div id="admin-ui">
        <div class="admin-wrap">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid var(--p); padding-bottom: 20px;">
                <h2 style="color:var(--accent); font-size:28px;">ТЕРМИНАЛ УПРАВЛЕНИЯ [dqmjrka]</h2>
                <div class="hud-pill" style="border-color:var(--accent);">ROOT ACCESS</div>
            </div>
            <div class="player-table" id="admin-list"></div>
            <button class="btn-s" style="margin-top:35px; width:100%;" onclick="document.getElementById('admin-ui').style.display='none'">ВЫХОД ИЗ СИСТЕМЫ (P)</button>
        </div>
    </div>

    <div id="scr-pause" class="overlay hidden" style="background: rgba(2,6,23,0.97); z-index: 3500;">
        <div class="card" style="width: 400px;">
            <h2 style="margin-bottom: 35px; letter-spacing: 10px; font-size: 30px;">ПАУЗА</h2>
            <button class="btn-p" id="do-resume" style="width:100%; margin-bottom:20px;">ПРОДОЛЖИТЬ</button>
            <button class="btn-s" id="do-quit" style="width:100%; color: var(--d); border-color: var(--d);">ПОКИНУТЬ БОЙ</button>
        </div>
    </div>

    <div id="hud">
        <div class="hud-top">
            <div class="hud-pill" id="hud-ping">ПИНГ: --ms</div>
            <div class="hud-pill" id="hud-online">ОБЪЕКТОВ: 1</div>
            <div class="hud-pill" id="hud-map">ЛОКАЦИЯ: ALPHA</div>
        </div>

        <div id="chat-sys">
            <div id="chat-logs"></div>
            <input type="text" id="chat-input" placeholder="Введите сообщение...">
        </div>

        <div class="health-container">
            <div id="hp-label" style="font-weight: 950; font-size: 22px; letter-spacing: 2px;">100 HP</div>
            <div class="health-bar"><div id="health-val"></div></div>
        </div>

        <div class="ammo-container">
            <div id="reload-msg" class="blink" style="color:var(--warning); font-size:15px; font-weight:900; display:none; margin-bottom:10px;">ТРЕБУЕТСЯ ПЕРЕЗАРЯДКА</div>
            <div id="ammo-num">12</div>
            <div style="font-size:13px; font-weight:900; color:var(--accent); letter-spacing: 4px;">MAGAZINE</div>
        </div>

        <div id="dot"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, onDisconnect, update, remove, get, set, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        /**
         * КРИПТО-КОНФИГ v22.8
         * Используем твой новый ключ, разбитый на фрагменты.
         */
        const _k_1 = "AIzaSyDbRE1yEZlK";
        const _k_2 = "Wix3rmBO9qw4haxFmPxKTL0";

        const firebaseConfig = {
            apiKey: _k_1 + _k_2,
            authDomain: "clutch-shuter.firebaseapp.com",
            databaseURL: "https://clutch-shuter-default-rtdb.firebaseio.com",
            projectId: "clutch-shuter",
            storageBucket: "clutch-shuter.firebasestorage.app",
            appId: "1:224141175517:web:671a68999f8cf6a2dc4934"
        };

        // ИНИЦИАЛИЗАЦИЯ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // СОСТОЯНИЕ ИГРЫ
        let myHP = 100, myAmmo = 12, maxAmmo = 12, isDead = false, isReloading = false, activeMap = 'legacy';
        let ping = 0, isPaused = false, isChatting = false;
        let lastInteraction = Date.now();
        const AFK_TRESHOLD = 30000; // 30 секунд
        const enemies = {};
        const config = { 
            sens: parseFloat(localStorage.getItem('cl_sens')) || 1.2, 
            vol: parseFloat(localStorage.getItem('cl_vol')) || 0.5 
        };

        // НАВИГАЦИЯ ПО МЕНЮ
        const showScreen = (id) => {
            document.querySelectorAll('.overlay, .full-modal').forEach(s => s.classList.add('hidden'));
            if(id !== 'game') document.getElementById(id).classList.remove('hidden');
        };

        // ЛОГИКА КНОПОК
        document.getElementById('go-profile').onclick = async () => {
            const snap = await get(ref(db, `users/${auth.currentUser.uid}`));
            if(snap.exists()){
                document.getElementById('st-kills').innerText = snap.val().kills || 0;
                document.getElementById('st-deaths').innerText = snap.val().deaths || 0;
            }
            document.getElementById('scr-profile').style.display = 'flex';
        };

        document.getElementById('go-settings').onclick = () => {
            document.getElementById('val-sens').value = config.sens;
            document.getElementById('val-vol').value = config.vol;
            document.getElementById('scr-settings').style.display = 'flex';
        };

        document.getElementById('save-cfg').onclick = () => {
            config.sens = parseFloat(document.getElementById('val-sens').value);
            config.vol = parseFloat(document.getElementById('val-vol').value);
            localStorage.setItem('cl_sens', config.sens);
            localStorage.setItem('cl_vol', config.vol);
            document.getElementById('scr-settings').style.display = 'none';
        };

        document.querySelectorAll('.map-card').forEach(m => {
            m.onclick = () => {
                document.querySelectorAll('.map-card').forEach(x => x.classList.remove('active'));
                m.classList.add('active');
                activeMap = m.dataset.map;
            };
        });

        // AUTH ЛОГИКА
        document.getElementById('do-login').onclick = async () => {
            const nick = document.getElementById('auth-user').value;
            const email = nick.includes('@') ? nick : `${nick.toLowerCase()}@clutch.io`;
            try { await signInWithEmailAndPassword(auth, email, document.getElementById('auth-pass').value); }
            catch(e) { document.getElementById('auth-log').innerText = "КРИТИЧЕСКАЯ ОШИБКА: ОТКАЗАНО В ДОСТУПЕ"; }
        };

        document.getElementById('do-reg').onclick = async () => {
            const nick = document.getElementById('auth-user').value;
            try {
                const r = await createUserWithEmailAndPassword(auth, `${nick.toLowerCase()}@clutch.io`, document.getElementById('auth-pass').value);
                await updateProfile(r.user, { displayName: nick });
                await set(ref(db, `users/${r.user.uid}`), { kills: 0, deaths: 0 });
            } catch(e) { document.getElementById('auth-log').innerText = "ОШИБКА: ОБЪЕКТ УЖЕ В СИСТЕМЕ"; }
        };

        onAuthStateChanged(auth, u => {
            if(u) { 
                document.getElementById('ui-nick').innerText = u.displayName.toUpperCase(); 
                showScreen('scr-lobby'); 
                initNetwork();
            } else showScreen('scr-auth');
        });

        document.getElementById('go-logout').onclick = () => signOut(auth);

        // --- ГРАФИКА (THREE.JS CORE) ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.VSMShadowMap;
        document.body.appendChild(renderer.domElement);

        const ambLight = new THREE.AmbientLight(0xffffff, 0.4); scene.add(ambLight);
        const sun = new THREE.DirectionalLight(0xffffff, 1.5); sun.position.set(50, 200, 50); sun.castShadow = true;
        sun.shadow.camera.left = -200; sun.shadow.camera.right = 200;
        sun.shadow.camera.top = 200; sun.shadow.camera.bottom = -200;
        scene.add(sun);

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({color: 0x22c55e}));
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true;
        scene.add(floor);

        // МОДЕЛИ ИГРОКА
        const viewGroup = new THREE.Group();
        const gun = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.18, 0.8), new THREE.MeshStandardMaterial({color: 0x020617}));
        gun.position.set(0.35, -0.3, -0.6); viewGroup.add(gun);
        
        const armM = new THREE.MeshStandardMaterial({color: 0x2563eb});
        const armR = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.15, 0.6), armM);
        armR.position.set(0.35, -0.4, -0.2); viewGroup.add(armR);
        const armL = armR.clone(); armL.position.set(-0.35, -0.4, -0.3); armL.rotation.y = 0.4;
        viewGroup.add(armL);
        scene.add(viewGroup);

        const controls = new PointerLockControls(camera, document.body);

        function setupWorld(map) {
            scene.children.filter(c => c.isStatic).forEach(c => scene.remove(c));
            if(map === 'legacy') {
                scene.background = new THREE.Color(0x87ceeb);
                floor.material.color.set(0x22c55e);
                for(let i=0; i<45; i++){
                    const b = new THREE.Mesh(new THREE.BoxGeometry(10,12,10), new THREE.MeshStandardMaterial({color: 0x475569}));
                    b.position.set(Math.random()*400-200, 6, Math.random()*400-200);
                    b.isStatic = b.castShadow = b.receiveShadow = true; scene.add(b);
                }
            } else {
                scene.background = new THREE.Color(0x020617);
                floor.material.color.set(0x0f172a);
                for(let i=0; i<100; i++){
                    const w = new THREE.Mesh(new THREE.BoxGeometry(2, 20, 25), new THREE.MeshStandardMaterial({color: 0x1e293b}));
                    w.position.set(Math.random()*500-250, 10, Math.random()*500-250);
                    w.isStatic = true; scene.add(w);
                }
            }
        }

        // ЗВУКОВОЙ ДВИЖОК
        const aCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, t, d, v=0.1) {
            if(aCtx.state === 'suspended') aCtx.resume();
            const o = aCtx.createOscillator(), g = aCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, aCtx.currentTime);
            g.gain.setValueAtTime(v * config.vol, aCtx.currentTime);
            o.connect(g); g.connect(aCtx.destination);
            o.start(); o.stop(aCtx.currentTime + d);
        }

        // СЕТЬ И АДМИНКА
        function initNetwork() {
            onValue(ref(db, 'players'), s => {
                const count = s.exists() ? Object.keys(s.val()).length : 0;
                document.getElementById('hud-online').innerText = `ОБЪЕКТОВ: ${count}`;
                
                if(auth.currentUser.displayName === 'dqmjrka') {
                    const list = document.getElementById('admin-list');
                    list.innerHTML = '';
                    const players = s.val() || {};
                    for(let id in players) {
                        const row = document.createElement('div');
                        row.className = 'player-item';
                        row.innerHTML = `
                            <span><b>${players[id].nick}</b> <small>[${id.slice(0,8)}]</small></span>
                            <div>
                                <button class="btn-s" style="padding:10px 18px; font-size:11px;" onclick="kickPl('${id}')">KICK</button>
                                <button class="btn-d" style="padding:10px 18px; font-size:11px; margin-left:10px;" onclick="banPl('${id}')">BAN</button>
                            </div>
                        `;
                        list.appendChild(row);
                    }
                }
            });

            // ЧАТ
            onValue(ref(db, `chats/${activeMap}`), s => {
                const msgs = s.val() || {};
                const log = document.getElementById('chat-logs');
                log.innerHTML = '';
                Object.values(msgs).slice(-8).forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'msg-line';
                    div.innerHTML = `<b style="color:var(--accent)">${m.u}:</b> ${m.t}`;
                    log.appendChild(div);
                });
            });

            setInterval(() => {
                const start = Date.now();
                update(ref(db, `players/${auth.currentUser.uid}`), { online: true }).then(() => {
                    ping = Date.now() - start;
                    document.getElementById('hud-ping').innerText = `ПИНГ: ${ping}ms`;
                });
            }, 3500);
        }

        window.kickPl = (id) => remove(ref(db, `players/${id}`));
        window.banPl = (id) => {
            remove(ref(db, `players/${id}`));
            remove(ref(db, `users/${id}`));
        };

        function createEnemy() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.4), new THREE.MeshStandardMaterial({color: 0xef4444}));
            body.position.y = 1.2; group.add(body);
            
            const canvas = document.createElement('canvas'); canvas.width = 300; canvas.height = 100;
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: tex}));
            sprite.position.y = 3.5; sprite.scale.set(2.5, 0.8, 1); group.add(sprite);
            return { group, hit: body, ctx: canvas.getContext('2d'), tex };
        }

        function runSync() {
            const mRef = ref(db, `players/${auth.currentUser.uid}`);
            onDisconnect(mRef).remove();
            
            onValue(mRef, snap => {
                if(!snap.exists() && !isDead) { location.reload(); }
            });

            onValue(ref(db, 'players'), snap => {
                const data = snap.val(); if(!data) return;
                for(let id in data) {
                    const d = data[id];
                    if(id === auth.currentUser.uid) {
                        if(d.hp < myHP) {
                            myHP = d.hp; updateHUD();
                            document.getElementById('damage-fx').style.opacity = 1;
                            setTimeout(()=>document.getElementById('damage-fx').style.opacity=0, 100);
                            playSfx(100, 'sine', 0.2, 0.8);
                            if(myHP <= 0 && !isDead) { isDead = true; location.reload(); }
                        }
                        continue;
                    }
                    if(d.map !== activeMap) { if(enemies[id]) { scene.remove(enemies[id].group); delete enemies[id]; } continue; }
                    if(!enemies[id]) { enemies[id] = createEnemy(); scene.add(enemies[id].group); }
                    const e = enemies[id];
                    e.group.position.lerp(new THREE.Vector3(d.x, d.y, d.z), 0.2);
                    e.group.rotation.y = d.ry;
                    const c = e.ctx; c.clearRect(0,0,300,100);
                    c.fillStyle = '#fff'; c.font = 'bold 30px Arial'; c.textAlign = 'center';
                    c.fillText(d.nick || 'UNKNOWN', 150, 40);
                    c.fillStyle = 'rgba(0,0,0,0.6)'; c.fillRect(50, 60, 200, 15);
                    c.fillStyle = d.hp > 30 ? '#22c55e' : '#ef4444'; c.fillRect(50, 60, (d.hp/100)*200, 15);
                    e.tex.needsUpdate = true;
                }
                for(let id in enemies) { if(!data[id]) { scene.remove(enemies[id].group); delete enemies[id]; } }
            });
        }

        function updateHUD() {
            document.getElementById('hp-label').innerText = `${Math.ceil(myHP)} HP`;
            document.getElementById('health-val').style.width = myHP + '%';
            document.getElementById('ammo-num').innerText = myAmmo;
        }

        // ДЕЙСТВИЯ
        document.getElementById('go-deploy').onclick = () => {
            setupWorld(activeMap);
            showScreen('game'); document.getElementById('hud').style.display = 'block';
            controls.lock();
            camera.position.set(0, 1.7, 0);
            runSync();
        };

        const ray = new THREE.Raycaster();
        window.onmousedown = (e) => {
            if(!controls.isLocked || isDead || isReloading || isPaused || isChatting) return;
            if(myAmmo <= 0) { reload(); return; }
            myAmmo--; updateHUD();
            playSfx(200, 'sawtooth', 0.1, 0.4);
            gun.position.z += 0.15;
            lastInteraction = Date.now();

            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            for(let id in enemies) {
                if(ray.intersectObject(enemies[id].hit).length > 0) {
                    playSfx(1200, 'sine', 0.05, 0.2);
                    runTransaction(ref(db, `players/${id}/hp`), cur => {
                        const next = (cur || 100) - 20;
                        if(next <= 0) runTransaction(ref(db, `users/${auth.currentUser.uid}/kills`), c => (c || 0) + 1);
                        return next;
                    });
                }
            }
        };

        function reload() {
            if(isReloading || myAmmo === maxAmmo) return;
            isReloading = true;
            document.getElementById('reload-msg').style.display = 'block';
            playSfx(350, 'square', 0.4, 0.3);
            viewGroup.position.y -= 0.6;
            setTimeout(() => {
                myAmmo = maxAmmo; isReloading = false;
                document.getElementById('reload-msg').style.display = 'none';
                updateHUD(); viewGroup.position.y += 0.6;
            }, 1800);
        }

        // КЛАВИШИ
        window.onkeydown = e => {
            if(e.code === 'Enter') {
                if(!isChatting) {
                    isChatting = true;
                    document.getElementById('chat-input').style.display = 'block';
                    document.getElementById('chat-input').focus();
                } else {
                    const t = document.getElementById('chat-input').value;
                    if(t.trim()) {
                        const cRef = ref(db, `chats/${activeMap}`);
                        update(cRef, { [Date.now()]: { u: auth.currentUser.displayName, t: t } });
                    }
                    document.getElementById('chat-input').value = '';
                    document.getElementById('chat-input').style.display = 'none';
                    isChatting = false;
                }
            }
            if(e.code === 'KeyP' && auth.currentUser.displayName === 'dqmjrka') {
                document.getElementById('admin-ui').style.display = 'flex';
                controls.unlock();
            }
            if(e.code === 'Escape') {
                if(isPaused) { controls.lock(); document.getElementById('scr-pause').classList.add('hidden'); isPaused = false; }
                else if(controls.isLocked) { controls.unlock(); document.getElementById('scr-pause').classList.remove('hidden'); isPaused = true; }
            }
            if(e.code === 'KeyR') reload();
        };

        document.getElementById('do-resume').onclick = () => { controls.lock(); document.getElementById('scr-pause').classList.add('hidden'); isPaused = false; };
        document.getElementById('do-quit').onclick = () => location.reload();

        // ЦИКЛ
        const keys = {};
        window.onkeydown = (old => e => { old(e); keys[e.code] = true; })(window.onkeydown);
        window.onkeyup = e => keys[e.code] = false;

        const clock = new THREE.Clock();
        let lSync = 0, bT = 0;

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // AFK CHECK (30s)
            if(controls.isLocked && Date.now() - lastInteraction > AFK_TRESHOLD) {
                location.reload(); 
            }

            if(controls.isLocked && !isDead && !isPaused && !isChatting) {
                const spd = 12 * dt;
                let moved = false;
                if(keys['KeyW']) { controls.moveForward(spd); moved = true; }
                if(keys['KeyS']) { controls.moveForward(-spd); moved = true; }
                if(keys['KeyA']) { controls.moveRight(-spd); moved = true; }
                if(keys['KeyD']) { controls.moveRight(spd); moved = true; }

                if(moved) {
                    lastInteraction = Date.now();
                    bT += dt * 15;
                    camera.position.y = 1.7 + Math.sin(bT) * 0.05;
                } else {
                    camera.position.y = THREE.MathUtils.lerp(camera.position.y, 1.7, 0.1);
                }

                viewGroup.position.copy(camera.position);
                viewGroup.quaternion.copy(camera.quaternion);
                gun.position.z = THREE.MathUtils.lerp(gun.position.z, -0.6, 0.15);

                if(Date.now() - lSync > 33) {
                    update(ref(db, `players/${auth.currentUser.uid}`), {
                        x: camera.position.x, y: camera.position.y - 1.7, z: camera.position.z,
                        ry: camera.rotation.y, nick: auth.currentUser.displayName, hp: myHP, map: activeMap
                    });
                    lSync = Date.now();
                }
            }
            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
