<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUTCH | v1.0 BETA</title>
    <style>
        :root { 
            --p: #2563eb; --s: #64748b; --d: #ef4444; --bg: #0f172a;
            --glass: rgba(15, 23, 42, 0.8);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; }

        /* ЭКРАНЫ И МЕНЮ */
        .ui-screen {
            position: absolute; inset: 0; display: flex; 
            align-items: center; justify-content: center; 
            z-index: 2000; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        .card {
            width: 500px; padding: 60px; background: var(--glass);
            border-radius: 40px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px); text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        h1 { font-size: 60px; font-weight: 900; letter-spacing: -3px; margin-bottom: 10px; }
        .meta { color: var(--s); font-size: 12px; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 30px; }

        input {
            width: 100%; padding: 18px; margin-bottom: 12px; border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3);
            color: #fff; font-size: 16px; outline: none;
        }

        .row { display: flex; gap: 10px; margin-top: 10px; }
        button {
            flex: 1; padding: 18px; border-radius: 15px; border: none;
            font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .btn-p { background: var(--p); color: #fff; }
        .btn-s { background: rgba(255,255,255,0.1); color: #fff; }
        button:hover { transform: translateY(-2px); filter: brightness(1.2); }

        /* ИГРОВОЙ ИНТЕРФЕЙС */
        #hud {
            position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000;
        }
        .hud-top { position: absolute; top: 30px; left: 30px; display: flex; gap: 20px; }
        .hud-stat { background: var(--glass); padding: 10px 20px; border-radius: 15px; font-weight: 800; border: 1px solid rgba(255,255,255,0.05); }
        
        .hud-bottom { position: absolute; bottom: 30px; left: 30px; }
        .hp-box { width: 250px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; height: 12px; margin-top: 10px; }
        #hp-bar { width: 100%; height: 100%; background: var(--d); transition: 0.3s; }

        #cross {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%;
        }

        #esc-menu {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            z-index: 3000; display: none; align-items: center; justify-content: center;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="hud-top">
            <div class="hud-stat" id="live-ping">PING: --ms</div>
            <div class="hud-stat" id="live-online">ONLINE: 1</div>
        </div>
        <div class="hud-bottom">
            <div id="ammo-count" style="font-size: 32px; font-weight: 900;">12 / 12</div>
            <div class="hp-box"><div id="hp-bar"></div></div>
        </div>
        <div id="cross"></div>
    </div>

    <div id="esc-menu">
        <div class="card" style="width: 300px;">
            <h2>PAUSED</h2>
            <button class="btn-p" id="resume" style="width:100%; margin: 20px 0 10px;">RESUME</button>
            <button class="btn-s" id="quit" style="width:100%;">LOBBY</button>
        </div>
    </div>

    <div id="scr-auth" class="ui-screen">
        <div class="card">
            <h1>CLUTCH</h1>
            <div class="meta">Network Warfare v16.0</div>
            <input type="email" id="email" placeholder="Email">
            <input type="text" id="nick" placeholder="Nickname">
            <input type="password" id="pass" placeholder="Password">
            <div class="row">
                <button class="btn-p" id="login">LOG IN</button>
                <button class="btn-s" id="reg">SIGN UP</button>
            </div>
            <p id="auth-err" style="color:var(--d); font-size:12px; margin-top:15px; font-weight:bold;"></p>
        </div>
    </div>

    <div id="scr-lobby" class="ui-screen hidden">
        <div class="card">
            <h1 id="user-display">SOLDIER</h1>
            <div class="meta" id="lobby-stats">PING: -- | ONLINE: --</div>
            <button class="btn-p" id="play" style="width:100%; height:80px; font-size:24px; margin-bottom:12px;">DEPLOY</button>
            <div class="row">
                <button class="btn-s" id="open-settings">SETTINGS</button>
                <button class="btn-s" id="logout">LOG OUT</button>
            </div>
        </div>
    </div>

    <div id="scr-settings" class="ui-screen hidden">
        <div class="card">
            <h1>SETTINGS</h1>
            <div style="text-align:left; margin: 30px 0;">
                <label>Sensitivity</label>
                <input type="range" id="set-sens" min="0.1" max="5.0" step="0.1" style="width:100%;">
                <label>Volume</label>
                <input type="range" id="set-vol" min="0" max="1" step="0.1" style="width:100%;">
            </div>
            <button class="btn-p" id="save-settings" style="width:100%;">SAVE</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, onDisconnect, update, remove, get, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDRH07hc8tMsG1TvMyHOptrOTEJDp_4kE8",
            authDomain: "clutch-shuter.firebaseapp.com",
            projectId: "clutch-shuter",
            databaseURL: "https://clutch-shuter-default-rtdb.firebaseio.com",
            storageBucket: "clutch-shuter.firebasestorage.app",
            appId: "1:224141175517:web:671a68999f8cf6a2dc4934"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // STATE
        let myHP = 100, myAmmo = 12, isMatch = false, isDead = false, ping = 0;
        const enemies = {};
        const config = { sens: parseFloat(localStorage.getItem('c_sens')) || 1.0, vol: parseFloat(localStorage.getItem('c_vol')) || 0.5 };

        // AUDIO
        const aCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(freq, type, dur) {
            const o = aCtx.createOscillator(); const g = aCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, aCtx.currentTime);
            g.gain.setValueAtTime(config.vol * 0.1, aCtx.currentTime);
            o.connect(g); g.connect(aCtx.destination);
            o.start(); o.stop(aCtx.currentTime + dur);
        }

        // UI
        const show = (id) => {
            document.querySelectorAll('.ui-screen').forEach(s => s.classList.add('hidden'));
            if(id !== 'game') document.getElementById(id).classList.remove('hidden');
        };

        // AUTH LOGIC
        document.getElementById('login').onclick = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); }
            catch(e) { document.getElementById('auth-err').innerText = e.message; }
        };
        document.getElementById('reg').onclick = async () => {
            try {
                const r = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value);
                await updateProfile(r.user, { displayName: document.getElementById('nick').value });
            } catch(e) { document.getElementById('auth-err').innerText = e.message; }
        };
        onAuthStateChanged(auth, (u) => {
            if(u) { document.getElementById('user-display').innerText = u.displayName; show('scr-lobby'); updateStats(); }
            else show('scr-auth');
        });
        document.getElementById('logout').onclick = () => signOut(auth);

        // SETTINGS
        document.getElementById('open-settings').onclick = () => {
            document.getElementById('set-sens').value = config.sens;
            document.getElementById('set-vol').value = config.vol;
            show('scr-settings');
        };
        document.getElementById('save-settings').onclick = () => {
            config.sens = parseFloat(document.getElementById('set-sens').value);
            config.vol = parseFloat(document.getElementById('set-vol').value);
            localStorage.setItem('c_sens', config.sens);
            localStorage.setItem('c_vol', config.vol);
            show('scr-lobby');
        };

        // 3D ENGINE
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // ДЕНЬ
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(50, 100, 50); sun.castShadow = true;
        scene.add(sun);

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({color: 0x4ade80}));
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true;
        scene.add(floor);

        // BUILD WORLD
        const box = (w,h,d,x,z) => {
            const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color: 0x94a3b8}));
            m.position.set(x, h/2, z); m.castShadow = true; m.receiveShadow = true;
            scene.add(m);
        };
        box(100, 5, 1, 0, 50); box(100, 5, 1, 0, -50); box(1, 5, 100, 50, 0); box(1, 5, 100, -50, 0);
        box(10, 4, 10, 20, 20); box(10, 4, 10, -20, -20);

        const gunPivot = new THREE.Group();
        const gunM = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.5), new THREE.MeshStandardMaterial({color: 0x1e293b}));
        gunM.position.set(0.3, -0.3, -0.5); gunPivot.add(gunM);
        scene.add(gunPivot);

        const controls = new PointerLockControls(camera, document.body);

        // NETWORK LOBBY DATA
        function updateStats() {
            onValue(ref(db, 'players'), (s) => {
                const count = s.exists() ? Object.keys(s.val()).length : 0;
                document.getElementById('live-online').innerText = `ONLINE: ${count}`;
                document.getElementById('lobby-stats').innerText = `PING: ${ping}ms | ONLINE: ${count}`;
            });
            setInterval(() => {
                const start = Date.now();
                update(ref(db, `players/${auth.currentUser.uid}`), { t: serverTimestamp() }).then(() => {
                    ping = Date.now() - start;
                    document.getElementById('live-ping').innerText = `PING: ${ping}ms`;
                });
            }, 3000);
        }

        // PLAYER MODEL BUILDER
        function createPlayerModel() {
            const group = new THREE.Group();
            
            // Body
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1), new THREE.MeshStandardMaterial({color: 0x2563eb}));
            body.position.y = 1; group.add(body);

            // Eyes
            const eyeM = new THREE.MeshStandardMaterial({color: 0x000});
            const eyeL = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.1), eyeM);
            eyeL.position.set(-0.15, 1.6, -0.35); group.add(eyeL);
            const eyeR = eyeL.clone(); eyeR.position.x = 0.15; group.add(eyeR);

            // Hands
            const armG = new THREE.BoxGeometry(0.15, 0.6, 0.15);
            const armL = new THREE.Mesh(armG, new THREE.MeshStandardMaterial({color: 0x2563eb}));
            armL.position.set(-0.5, 1.2, 0); group.add(armL);
            const armR = armL.clone(); armR.position.x = 0.5; group.add(armR);

            // Legs
            const legG = new THREE.BoxGeometry(0.2, 0.7, 0.2);
            const legL = new THREE.Mesh(legG, new THREE.MeshStandardMaterial({color: 0x1e293b}));
            legL.position.set(-0.2, 0.35, 0); group.add(legL);
            const legR = legL.clone(); legR.position.x = 0.2; group.add(legR);

            // Weapon in hand
            const pGun = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.5), new THREE.MeshStandardMaterial({color: 0x000}));
            pGun.position.set(0.5, 1.1, -0.3); group.add(pGun);

            // UI
            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 128;
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: tex}));
            sprite.position.y = 2.8; sprite.scale.set(2, 1, 1);
            group.add(sprite);

            return { group, hit: body, ctx: canvas.getContext('2d'), tex };
        }

        function initOnline() {
            const myRef = ref(db, `players/${auth.currentUser.uid}`);
            onDisconnect(myRef).remove();

            onValue(ref(db, 'players'), (snap) => {
                const data = snap.val(); if(!data) return;
                for(let id in data) {
                    if(id === auth.currentUser.uid) {
                        if(data[id].hp < myHP) {
                            myHP = data[id].hp; playSfx(1000, 'sine', 0.2); // Звук попадания по мне
                            document.getElementById('hp-bar').style.width = myHP + '%';
                            if(myHP <= 0 && !isDead) { isDead = true; location.reload(); }
                        }
                        continue;
                    }
                    if(!enemies[id]) {
                        const m = createPlayerModel();
                        scene.add(m.group);
                        enemies[id] = m;
                    }
                    const e = enemies[id]; const d = data[id];
                    e.group.position.set(d.x, d.y, d.z);
                    e.group.rotation.y = d.ry;
                    e.hp = d.hp;
                    
                    const ctx = e.ctx; ctx.clearRect(0,0,256,128);
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 28px Arial'; ctx.textAlign = 'center';
                    ctx.fillText(d.nick || 'Player', 128, 40);
                    ctx.fillStyle = '#1e293b'; ctx.fillRect(50, 60, 156, 12);
                    ctx.fillStyle = d.hp > 30 ? '#4ade80' : '#ef4444';
                    ctx.fillRect(50, 60, (d.hp/100)*156, 12);
                    ctx.fillStyle = '#94a3b8'; ctx.font = '16px Arial';
                    ctx.fillText(`Ping: ${d.p || 0}ms`, 128, 95);
                    e.tex.needsUpdate = true;
                }
                for(let id in enemies) { if(!data[id]) { scene.remove(enemies[id].group); delete enemies[id]; } }
            });
        }

        // GAMEPLAY
        document.getElementById('play').onclick = () => {
            if(aCtx.state === 'suspended') aCtx.resume();
            show('game'); isMatch = true;
            document.getElementById('hud').style.display='block';
            controls.lock();
            camera.position.set(Math.random()*20-10, 1.7, Math.random()*20-10);
            initOnline();
        };

        const ray = new THREE.Raycaster();
        window.onmousedown = (e) => {
            if(!controls.isLocked || isDead || e.button !== 0) return;
            if(myAmmo <= 0) return;
            myAmmo--; document.getElementById('ammo-count').innerText = `${myAmmo} / 12`;
            playSfx(150, 'sawtooth', 0.1);
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            for(let id in enemies) {
                if(ray.intersectObject(enemies[id].hit).length > 0) {
                    playSfx(1200, 'sine', 0.05); // Звук попадания по врагу
                    update(ref(db, `players/${id}`), { hp: Math.max(0, enemies[id].hp - 20) });
                }
            }
            if(myAmmo === 0) setTimeout(() => { myAmmo = 12; document.getElementById('ammo-count').innerText = `12 / 12`; }, 2000);
        };

        // LOOP
        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        let lastUpdate = 0;
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if(controls.isLocked && isMatch && !isDead) {
                const moveSpeed = 8 * delta; // Фикс скорости через delta
                if(keys['KeyW']) controls.moveForward(moveSpeed);
                if(keys['KeyS']) controls.moveForward(-moveSpeed);
                if(keys['KeyA']) controls.moveRight(-moveSpeed);
                if(keys['KeyD']) controls.moveRight(moveSpeed);

                camera.position.x = Math.max(-48, Math.min(48, camera.position.x));
                camera.position.z = Math.max(-48, Math.min(48, camera.position.z));
                gunPivot.position.copy(camera.position); gunPivot.quaternion.copy(camera.quaternion);

                // Throttle сетевых обновлений (30 раз в сек макс)
                if(Date.now() - lastUpdate > 33) {
                    update(ref(db, `players/${auth.currentUser.uid}`), {
                        x: camera.position.x, y: camera.position.y-1.7, z: camera.position.z,
                        ry: camera.rotation.y, nick: auth.currentUser.displayName, hp: myHP, p: ping
                    });
                    lastUpdate = Date.now();
                }
            }
            renderer.render(scene, camera);
        }
        animate();

        // ESC
        document.getElementById('resume').onclick = () => controls.lock();
        document.getElementById('quit').onclick = () => location.reload();
        document.addEventListener('keydown', (e) => { if(e.code === 'Escape') document.getElementById('esc-menu').style.display='flex'; });
        controls.addEventListener('lock', () => document.getElementById('esc-menu').style.display='none');
    </script>
</body>
</html>
